<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Pro V2 - Trading Bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --bg-card-hover: #1c2951;
            --accent-blue: #00d4ff;
            --accent-purple: #a855f7;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #fbbf24;
            --accent-orange: #f97316;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255, 255, 255, 0.08);
            --glow-blue: rgba(0, 212, 255, 0.3);
            --glow-purple: rgba(168, 85, 247, 0.3);
            --glow-green: rgba(34, 197, 94, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0d1b2a 100%);
            font-family: 'Inter', 'Segoe UI', sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(34, 197, 94, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        .card {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.8) 100%);
            border-radius: 16px;
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 0 40px rgba(0, 212, 255, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            padding: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 30px rgba(0, 0, 0, 0.4),
                0 0 50px rgba(0, 212, 255, 0.05);
        }

        .card-glow-blue {
            border-top: 2px solid var(--accent-blue);
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 -5px 30px var(--glow-blue);
        }

        .card-glow-green {
            border-top: 2px solid var(--accent-green);
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 -5px 30px var(--glow-green);
        }

        .card-glow-purple {
            border-top: 2px solid var(--accent-purple);
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 -5px 30px var(--glow-purple);
        }

        .input-dense {
            padding: 8px 12px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .input-dense:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 3px var(--glow-blue);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.70rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .bg-win {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .bg-loss {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .bg-run {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 212, 255, 0.1) 100%);
            color: var(--accent-blue);
            border: 1px solid rgba(0, 212, 255, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 212, 255, 0.3); }
            50% { box-shadow: 0 0 15px rgba(0, 212, 255, 0.5); }
        }

        .bg-neutral {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-secondary);
            border: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .bg-ignored {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(251, 191, 36, 0.1) 100%);
            color: var(--accent-yellow);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        /* Headers para separar secciones */
        .section-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent-blue);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 2px;
        }

        /* Estilos para sliders */
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .slider-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-blue);
            text-align: right;
            text-shadow: 0 0 10px var(--glow-blue);
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            outline: none;
            border: 1px solid var(--border-color);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            cursor: pointer;
            box-shadow: 0 0 15px var(--glow-blue);
            transition: all 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px var(--glow-blue);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 15px var(--glow-blue);
        }
        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(100, 116, 139, 0.3);
            transition: 0.4s;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .sl-disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        /* BotÃ³n reset individual */
        .reset-btn {
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }
        .reset-btn:hover {
            color: var(--accent-blue);
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 10px var(--glow-blue);
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Botones de precisiÃ³n < > */
        .precision-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }
        .precision-btn {
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .precision-btn:hover {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 0 15px var(--glow-blue);
            transform: scale(1.1);
        }
        .precision-btn:active {
            transform: scale(0.95);
        }
        .slider-with-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .slider-with-controls input[type="range"] {
            flex: 1;
        }

        /* Case panels styling */
        .case-panel {
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        .case-panel:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        .case-panel.case-1 { border-left: 3px solid var(--accent-blue); }
        .case-panel.case-2 { border-left: 3px solid var(--accent-yellow); }
        .case-panel.case-3 { border-left: 3px solid var(--accent-orange); }
        .case-panel.case-4 { border-left: 3px solid var(--accent-red); }
        .case-panel.case-5 { border-left: 3px solid var(--accent-purple); background: rgba(168, 85, 247, 0.05); }

        /* KPI Cards */
        .kpi-card {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.6) 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        .kpi-card.kpi-blue::before { background: var(--accent-blue); }
        .kpi-card.kpi-green::before { background: var(--accent-green); }
        .kpi-card.kpi-purple::before { background: var(--accent-purple); }
        .kpi-card.kpi-gray::before { background: var(--text-muted); }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .kpi-value.positive { 
            background: linear-gradient(135deg, var(--accent-green) 0%, #86efac 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }
        .kpi-value.negative { 
            background: linear-gradient(135deg, var(--accent-red) 0%, #fca5a5 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Table styling */
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .modern-table thead {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.2) 100%);
        }
        .modern-table th {
            padding: 14px 16px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }
        .modern-table td {
            padding: 12px 16px;
            font-size: 0.85rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }
        .modern-table tbody tr {
            transition: all 0.2s;
        }
        .modern-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        .modern-table tbody tr.row-c1 { border-left: 3px solid var(--accent-blue); }
        .modern-table tbody tr.row-c11 { border-left: 3px solid #38bdf8; background: rgba(56, 189, 248, 0.05); }
        .modern-table tbody tr.row-c2 { border-left: 3px solid var(--accent-yellow); }
        .modern-table tbody tr.row-c3 { border-left: 3px solid var(--accent-orange); }
        .modern-table tbody tr.row-c4 { border-left: 3px solid var(--accent-red); }
        .modern-table tbody tr.row-c5 { border-left: 3px solid var(--accent-purple); background: rgba(168, 85, 247, 0.08); }
        .modern-table tbody tr.row-ignored { opacity: 0.5; }

        /* Filter buttons */
        .filter-btn {
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 20px var(--glow-blue);
        }
        .filter-btn.btn-c1:hover, .filter-btn.btn-c1.active { border-color: var(--accent-blue); color: var(--accent-blue); }
        .filter-btn.btn-c2:hover, .filter-btn.btn-c2.active { border-color: var(--accent-yellow); color: var(--accent-yellow); }
        .filter-btn.btn-c3:hover, .filter-btn.btn-c3.active { border-color: var(--accent-orange); color: var(--accent-orange); }
        .filter-btn.btn-c4:hover, .filter-btn.btn-c4.active { border-color: var(--accent-red); color: var(--accent-red); }
        .filter-btn.btn-c5:hover, .filter-btn.btn-c5.active { border-color: var(--accent-purple); color: var(--accent-purple); }

        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 15px var(--glow-blue);
        }
        .file-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--glow-blue);
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        input[type="checkbox"]:checked {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            border-color: transparent;
            box-shadow: 0 0 10px var(--glow-blue);
        }
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Header styling */
        .main-header {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.8) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 28px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        .main-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .main-title span {
            -webkit-text-fill-color: var(--accent-blue);
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-screen-2xl mx-auto space-y-6">

        <!-- Header -->
        <div class="main-header flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="main-title">ðŸš€ Simulador Trading Bot <span>V2</span></h1>
                <p class="text-sm text-slate-400 mt-1">AnÃ¡lisis profesional con separaciÃ³n de PnL Realizado vs Flotante</p>
            </div>
            <div class="file-input-wrapper">
                <button class="file-input-btn">ðŸ“‚ Cargar JSON</button>
                <input type="file" id="fileInput" accept=".json" />
            </div>
        </div>

        <div id="dashboard" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 animate-in">

            <!-- CONTROLES (Izquierda) -->
            <div class="lg:col-span-3 space-y-5">

                <div class="card card-glow-blue">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="section-header mb-0">ConfiguraciÃ³n por Caso</h3>
                        <button onclick="resetDefaults()" class="text-xs text-cyan-400 hover:text-cyan-300 transition-colors font-medium">âŸ² Restablecer</button>
                    </div>

                    <!-- Loop generation for inputs could be done via JS, but static is clearer for editing -->
                    <div class="space-y-4">
                        <!-- C1 -->
                        <div class="case-panel case-1">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-sm" style="color: var(--accent-blue)">âš¡ CASO 1 & 1+</div>
                                <div class="toggle-container">
                                    <span class="text-[10px] text-slate-400">SL</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sl_enabled_c1" onchange="toggleSL(1); runSimulation();" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">TP Fib % <span class="text-red-400">(mÃ¡x 61.8)</span></label>
                                        <button onclick="resetSlider('tp_c1', 40)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('tp_c1', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="tp_c1" value="40" min="0" max="61.8" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('tp_c1', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="tp_c1_val">40</span>
                                </div>
                                <div class="slider-container" id="sl_container_c1">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">SL Fib % <span class="text-red-400">(mÃ­n 62)</span></label>
                                        <button onclick="resetSlider('sl_c1', 110)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('sl_c1', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="sl_c1" value="110" min="62" max="200" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('sl_c1', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="sl_c1_val">110</span>
                                </div>
                            </div>
                        </div>
                        <!-- C2 -->
                        <div class="case-panel case-2">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-sm" style="color: var(--accent-yellow)">ðŸ“Š CASO 2</div>
                                <div class="toggle-container">
                                    <span class="text-[10px] text-slate-400">SL</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sl_enabled_c2" onchange="toggleSL(2); runSimulation();" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">TP Fib % <span class="text-red-400">(mÃ¡x 61.8)</span></label>
                                        <button onclick="resetSlider('tp_c2', 45)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('tp_c2', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="tp_c2" value="45" min="0" max="61.8" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('tp_c2', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="tp_c2_val">45</span>
                                </div>
                                <div class="slider-container" id="sl_container_c2">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">SL Fib % <span class="text-red-400">(mÃ­n 69)</span></label>
                                        <button onclick="resetSlider('sl_c2', 110)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('sl_c2', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="sl_c2" value="110" min="69" max="200" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('sl_c2', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="sl_c2_val">110</span>
                                </div>
                            </div>
                        </div>
                        <!-- C3 -->
                        <div class="case-panel case-3">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-sm" style="color: var(--accent-orange)">ðŸ”¥ CASO 3</div>
                                <div class="toggle-container">
                                    <span class="text-[10px] text-slate-400">SL</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sl_enabled_c3" onchange="toggleSL(3); runSimulation();" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">TP Fib % <span class="text-red-400">(mÃ¡x 78.6)</span></label>
                                        <button onclick="resetSlider('tp_c3', 62)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('tp_c3', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="tp_c3" value="62" min="0" max="78.6" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('tp_c3', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="tp_c3_val">62</span>
                                </div>
                                <div class="slider-container" id="sl_container_c3">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">SL Fib % <span class="text-red-400">(mÃ­n 79)</span></label>
                                        <button onclick="resetSlider('sl_c3', 94)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('sl_c3', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="sl_c3" value="94" min="79" max="200" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('sl_c3', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="sl_c3_val">94</span>
                                </div>
                            </div>
                        </div>
                        <!-- C4 -->
                        <div class="case-panel case-4">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-sm" style="color: var(--accent-red)">ðŸ’Ž CASO 4</div>
                                <div class="toggle-container">
                                    <span class="text-[10px] text-slate-400">SL</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sl_enabled_c4" onchange="toggleSL(4); runSimulation();" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">TP Fib % <span class="text-red-400">(mÃ¡x 75)</span></label>
                                        <button onclick="resetSlider('tp_c4', 70)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('tp_c4', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="tp_c4" value="70" min="0" max="75" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('tp_c4', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="tp_c4_val">70</span>
                                </div>
                                <div class="slider-container" id="sl_container_c4">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">SL Fib % <span class="text-red-400">(mÃ­n 90)</span></label>
                                        <button onclick="resetSlider('sl_c4', 93)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('sl_c4', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="sl_c4" value="93" min="90" max="200" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('sl_c4', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="sl_c4_val">93</span>
                                </div>
                            </div>
                        </div>
                        <!-- C5 (Promediado C2/C3/C4 + C1++) -->
                        <div class="case-panel case-5">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="font-bold text-sm" style="color: var(--accent-purple)">âœ¨ CASO 5 (Promediado)</div>
                                    <label class="toggle-switch" title="Activar/desactivar promediado C5">
                                        <input type="checkbox" id="enableC5Averaging" onchange="runSimulation();" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="text-[10px] text-purple-300">SL</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="sl_enabled_c5" onchange="toggleSL(5); runSimulation();" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <p class="text-[10px] text-purple-300 mb-3 opacity-80">FusiÃ³n automÃ¡tica de C2/C3/C4 + C1++ cuando ambos se ejecutan y SL â‰¥ entry C1++</p>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="slider-container">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">TP Fib % <span class="text-purple-400">(mÃ¡x 61.8)</span></label>
                                        <button onclick="resetSlider('tp_c5', 45)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('tp_c5', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="tp_c5" value="45" min="0" max="61.8" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('tp_c5', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="tp_c5_val" style="color: var(--accent-purple); text-shadow: 0 0 10px var(--glow-purple);">45</span>
                                </div>
                                <div class="slider-container" id="sl_container_c5">
                                    <div class="slider-header">
                                        <label class="text-[10px] text-slate-400">SL Fib % <span class="text-purple-400">(mÃ­n 62)</span></label>
                                        <button onclick="resetSlider('sl_c5', 110)" class="reset-btn" title="Restablecer">â†º</button>
                                    </div>
                                    <div class="slider-with-controls">
                                        <button onclick="adjustSlider('sl_c5', -1)" class="precision-btn">&lt;</button>
                                        <input type="range" id="sl_c5" value="110" min="62" max="200" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                        <button onclick="adjustSlider('sl_c5', 1)" class="precision-btn">&gt;</button>
                                    </div>
                                    <span class="slider-value" id="sl_c5_val" style="color: var(--accent-purple); text-shadow: 0 0 10px var(--glow-purple);">110</span>
                                </div>
                            </div>
                            <div class="mt-3 p-3 rounded-lg flex items-center justify-between" style="background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3);">
                                <span class="text-[11px] text-purple-300 font-medium">ðŸ“Š Fusiones detectadas:</span>
                                <span id="c5_count" class="text-base font-bold px-3 py-1 rounded-lg" style="color: var(--accent-purple); background: rgba(168, 85, 247, 0.2); text-shadow: 0 0 15px var(--glow-purple);">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-glow-green">
                    <h3 class="section-header">Filtros de Ganancia ($)</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="slider-container">
                            <div class="slider-header">
                                <label class="text-[10px] text-slate-400">MÃ­nima (Excluir &lt; X)</label>
                                <button onclick="resetSlider('filter_min_profit', 0)" class="reset-btn" title="Restablecer">â†º</button>
                            </div>
                            <div class="slider-with-controls">
                                <button onclick="adjustSlider('filter_min_profit', -1)" class="precision-btn">&lt;</button>
                                <input type="range" id="filter_min_profit" value="0" min="0" max="5" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                <button onclick="adjustSlider('filter_min_profit', 1)" class="precision-btn">&gt;</button>
                            </div>
                            <span class="slider-value" id="filter_min_profit_val" style="color: var(--accent-green); text-shadow: 0 0 10px var(--glow-green);">0</span>
                        </div>
                        <div class="slider-container">
                            <div class="slider-header">
                                <label class="text-[10px] text-slate-400">MÃ¡xima (Excluir &gt; X)</label>
                                <button onclick="resetSlider('filter_max_profit', 0)" class="reset-btn" title="Restablecer">â†º</button>
                            </div>
                            <div class="slider-with-controls">
                                <button onclick="adjustSlider('filter_max_profit', -1)" class="precision-btn">&lt;</button>
                                <input type="range" id="filter_max_profit" value="0" min="0" max="5" step="0.1" oninput="updateSliderValue(this); runSimulation();">
                                <button onclick="adjustSlider('filter_max_profit', 1)" class="precision-btn">&gt;</button>
                            </div>
                            <span class="slider-value" id="filter_max_profit_val" style="color: var(--accent-green); text-shadow: 0 0 10px var(--glow-green);">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTADOS (Derecha) -->
            <div class="lg:col-span-9 space-y-5">

                <!-- KPIs Globales -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <!-- Realized -->
                    <div class="kpi-card kpi-blue">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">PnL Realizado</div>
                        <div class="kpi-value mt-2" id="kpi_realized_pnl">$0.00</div>
                        <div class="text-[10px] text-slate-500 mt-1">TP + SL + Manual</div>
                    </div>

                    <!-- Floating -->
                    <div class="kpi-card kpi-gray">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">PnL Flotante</div>
                        <div class="kpi-value mt-2" id="kpi_floating_pnl">$0.00</div>
                        <div class="text-[10px] text-slate-500 mt-1">Posiciones abiertas</div>
                    </div>

                    <!-- Total -->
                    <div class="kpi-card kpi-purple">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Combinado</div>
                        <div class="kpi-value mt-2" id="kpi_total_pnl">$0.00</div>
                        <div class="text-[10px] text-slate-500 mt-1">Real + Flotante</div>
                    </div>

                    <!-- Win Rate -->
                    <div class="kpi-card">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Win Rate</div>
                        <div class="kpi-value mt-2" id="kpi_winrate" style="color: var(--accent-blue);">0%</div>
                        <div class="text-[10px] text-slate-500 mt-1" id="kpi_trades_info">0/0 cerradas</div>
                    </div>

                    <!-- Profit Factor -->
                    <div class="kpi-card kpi-green">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Profit Factor</div>
                        <div class="kpi-value mt-2" id="kpi_pf" style="color: var(--accent-green);">0.00</div>
                        <div class="text-[10px] text-slate-500 mt-1">Cerradas</div>
                    </div>
                </div>

                <!-- Tabla de Rendimiento por Caso -->
                <div class="card overflow-hidden p-0">
                    <div class="p-4 border-b border-slate-700/30 flex items-center gap-3" style="background: linear-gradient(90deg, rgba(0, 212, 255, 0.1) 0%, transparent 100%);">
                        <span class="text-lg">ðŸ“Š</span>
                        <h3 class="font-bold text-slate-200 text-sm tracking-wide">Rendimiento por Caso</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Caso</th>
                                    <th class="text-center">Cerradas / Total</th>
                                    <th class="text-center">Win Rate</th>
                                    <th class="text-center">PF Promedio</th>
                                    <th class="text-right">PnL Realizado</th>
                                    <th class="text-right">PnL Flotante</th>
                                    <th class="text-right">PnL Total</th>
                                </tr>
                            </thead>
                            <tbody id="casesTableBody">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabla Detallada -->
                <div class="card overflow-hidden p-0">
                    <div class="p-4 border-b border-slate-700/30 flex flex-wrap justify-between items-center gap-4" style="background: linear-gradient(90deg, rgba(168, 85, 247, 0.1) 0%, transparent 100%);">
                        <div class="flex items-center gap-3">
                            <span class="text-lg">ðŸ“œ</span>
                            <h3 class="font-bold text-slate-200 text-sm tracking-wide">Lista de Operaciones</h3>
                        </div>
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="text-[10px] text-slate-400 font-semibold uppercase">Filtrar:</span>
                            <button onclick="setCasePriority(0)" id="btnCaseAll" class="filter-btn active">Todos</button>
                            <button onclick="setCasePriority(1)" id="btnCase1" class="filter-btn btn-c1">C1</button>
                            <button onclick="setCasePriority(11)" id="btnCase11" class="filter-btn btn-c1">C1++</button>
                            <button onclick="setCasePriority(2)" id="btnCase2" class="filter-btn btn-c2">C2</button>
                            <button onclick="setCasePriority(3)" id="btnCase3" class="filter-btn btn-c3">C3</button>
                            <button onclick="setCasePriority(4)" id="btnCase4" class="filter-btn btn-c4">C4</button>
                            <button onclick="setCasePriority(5)" id="btnCase5" class="filter-btn btn-c5">C5</button>
                            <span class="mx-2 text-slate-600">|</span>
                            <span class="text-[10px] text-slate-400 font-semibold uppercase">Ordenar:</span>
                            <button onclick="setSortMode('none')" id="btnSortNone" class="filter-btn active">Defecto</button>
                            <button onclick="setSortMode('pnl_real')" id="btnSortPnlReal" class="filter-btn" style="border-color: var(--accent-green);">PnL Real</button>
                            <button onclick="setSortMode('pnl_float')" id="btnSortPnlFloat" class="filter-btn" style="border-color: var(--accent-blue);">PnL Flot</button>
                        </div>
                    </div>
                    <div class="px-4 py-3 border-b border-slate-700/20 flex items-center justify-between flex-wrap gap-3" style="background: rgba(0, 0, 0, 0.2);">
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-slate-400" id="filter_stats_text"></span>
                        </div>
                        <div class="flex items-center gap-4 flex-wrap">
                            <span class="text-[10px] text-slate-400 font-semibold uppercase">Ignorar:</span>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="ignoreC1" onchange="runSimulation()">
                                <span class="text-xs group-hover:text-cyan-400 transition-colors" style="color: var(--accent-blue);">C1</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="ignoreC11" onchange="runSimulation()">
                                <span class="text-xs group-hover:text-cyan-400 transition-colors" style="color: var(--accent-blue);">C1++</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="ignoreC2" onchange="runSimulation()">
                                <span class="text-xs group-hover:text-yellow-300 transition-colors" style="color: var(--accent-yellow);">C2</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="ignoreC3" onchange="runSimulation()">
                                <span class="text-xs group-hover:text-orange-300 transition-colors" style="color: var(--accent-orange);">C3</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="ignoreC4" onchange="runSimulation()">
                                <span class="text-xs group-hover:text-red-300 transition-colors" style="color: var(--accent-red);">C4</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="ignoreC5" onchange="runSimulation()">
                                <span class="text-xs group-hover:text-purple-300 transition-colors" style="color: var(--accent-purple);">C5</span>
                            </label>
                            <span class="mx-2 text-slate-600">|</span>
                            <label class="flex items-center gap-2 cursor-pointer group" title="Cancelar C1++ si su C2/C3/C4 asociado cerrÃ³ en TP">
                                <input type="checkbox" id="cancelC1ppOnTP" onchange="runSimulation()">
                                <span class="text-xs font-medium group-hover:text-purple-300 transition-colors" style="color: var(--accent-purple);">Cancelar C1++ si TP âœ…</span>
                            </label>
                            <span class="mx-2 text-slate-600">|</span>
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <input type="checkbox" id="showIgnored" onchange="runSimulation()">
                                <span class="text-xs text-slate-400 group-hover:text-slate-300 transition-colors">Ver ignorados</span>
                            </label>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Origen</th>
                                    <th>Par</th>
                                    <th>Caso</th>
                                    <th>Entrada</th>
                                    <th class="text-center">New TP / SL</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">R:R</th>
                                    <th class="text-center">PF Trade</th>
                                    <th class="text-right">PnL Real</th>
                                    <th class="text-right">PnL Flotante</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let rawData = null;

        // FunciÃ³n para ajustar slider con precisiÃ³n
        function adjustSlider(sliderId, delta) {
            const slider = document.getElementById(sliderId);
            if (slider && !slider.disabled) {
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                const step = parseFloat(slider.step) || 1;
                let newValue = parseFloat(slider.value) + (delta * step);
                newValue = Math.max(min, Math.min(max, newValue));
                slider.value = newValue;
                updateSliderValue(slider);
                runSimulation();
            }
        }

        // FunciÃ³n para restablecer un slider individual
        function resetSlider(sliderId, defaultValue) {
            const slider = document.getElementById(sliderId);
            if (slider) {
                slider.value = defaultValue;
                updateSliderValue(slider);
                runSimulation();
            }
        }

        // FunciÃ³n para actualizar el valor mostrado del slider
        function updateSliderValue(slider) {
            const valSpan = document.getElementById(slider.id + '_val');
            if (valSpan) {
                valSpan.textContent = slider.value;
            }
        }

        // FunciÃ³n para activar/desactivar SL por caso
        function toggleSL(caseNum) {
            const checkbox = document.getElementById(`sl_enabled_c${caseNum}`);
            const slider = document.getElementById(`sl_c${caseNum}`);
            const valSpan = document.getElementById(`sl_c${caseNum}_val`);
            const container = document.getElementById(`sl_container_c${caseNum}`);
            
            if (checkbox.checked) {
                // Activar SL
                slider.disabled = false;
                slider.classList.remove('sl-disabled');
                container.querySelectorAll('label, span, button').forEach(el => el.classList.remove('sl-disabled'));
                valSpan.textContent = slider.value;
            } else {
                // Desactivar SL
                slider.disabled = true;
                slider.classList.add('sl-disabled');
                container.querySelectorAll('label, span, button').forEach(el => el.classList.add('sl-disabled'));
                valSpan.textContent = 'OFF';
            }
        }

        // Variable para almacenar el caso prioritario
        let casePriority = 0; // 0 = todos, 1, 11, 2, 3, 4

        // Variable para almacenar el modo de ordenamiento
        let sortMode = 'none'; // 'none', 'pnl_real', 'pnl_float'

        // FunciÃ³n para establecer modo de ordenamiento
        function setSortMode(mode) {
            sortMode = mode;
            // Actualizar estilos de botones de ordenamiento
            document.querySelectorAll('#btnSortNone, #btnSortPnlReal, #btnSortPnlFloat').forEach(btn => {
                btn.classList.remove('active');
            });
            const btnId = mode === 'none' ? 'btnSortNone' : (mode === 'pnl_real' ? 'btnSortPnlReal' : 'btnSortPnlFloat');
            const activeBtn = document.getElementById(btnId);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            runSimulation();
        }

        // FunciÃ³n para establecer prioridad de caso
        function setCasePriority(caseNum) {
            casePriority = caseNum;
            // Actualizar estilos de botones
            document.querySelectorAll('#btnCaseAll, #btnCase1, #btnCase11, #btnCase2, #btnCase3, #btnCase4, #btnCase5').forEach(btn => {
                btn.classList.remove('active');
            });
            const btnId = caseNum === 0 ? 'btnCaseAll' : `btnCase${caseNum}`;
            const activeBtn = document.getElementById(btnId);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            runSimulation();
        }

        // FunciÃ³n para restablecer valores por defecto
        function resetDefaults() {
            // Activar todos los SL por defecto
            [1, 2, 3, 4].forEach(c => {
                document.getElementById(`sl_enabled_c${c}`).checked = true;
                toggleSL(c);
            });
            // TP Defaults
            document.getElementById('tp_c1').value = 40;
            document.getElementById('tp_c2').value = 45;
            document.getElementById('tp_c3').value = 62;
            document.getElementById('tp_c4').value = 70;
            // SL Defaults (valores Ã³ptimos de la imagen)
            document.getElementById('sl_c1').value = 110;
            document.getElementById('sl_c2').value = 110;
            document.getElementById('sl_c3').value = 94;
            document.getElementById('sl_c4').value = 93;
            // Filters
            document.getElementById('filter_min_profit').value = 0;
            document.getElementById('filter_max_profit').value = 0;
            // Prioridad de caso
            setCasePriority(0);
            setSortMode('none');
            document.getElementById('showIgnored').checked = false;
            // Desmarcar checkboxes de ignorar casos
            document.getElementById('ignoreC1').checked = false;
            document.getElementById('ignoreC11').checked = false;
            document.getElementById('ignoreC2').checked = false;
            document.getElementById('ignoreC3').checked = false;
            document.getElementById('ignoreC4').checked = false;
            // Actualizar valores mostrados
            document.querySelectorAll('input[type="range"]').forEach(s => updateSliderValue(s));
            runSimulation();
        }

        // Inicializar valores de sliders al cargar
        document.addEventListener('DOMContentLoaded', function() {
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => updateSliderValue(slider));
            
            // Auto-cargar trades.json si estamos en servidor web
            autoLoadTradesJson();
        });

        // Variable para indicar si estamos en modo servidor web
        let isWebServer = false;

        async function autoLoadTradesJson() {
            // Intentar cargar archivos JSON automÃ¡ticamente (primero 2trades.json, luego trades.json)
            const filesToTry = ['/2trades.json', '/trades.json'];
            
            for (const fileName of filesToTry) {
                try {
                    // Usar timestamp + random para evitar cualquier cachÃ©
                    const cacheBuster = Date.now() + '-' + Math.random();
                    const response = await fetch(fileName + '?nocache=' + cacheBuster, {
                        cache: 'no-store',
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    if (response.ok) {
                        rawData = await response.json();
                        document.getElementById('dashboard').classList.remove('hidden');
                        runSimulation();
                        console.log('âœ… ' + fileName + ' cargado:', new Date().toLocaleTimeString());
                        isWebServer = true;
                        
                        // Mostrar botÃ³n de refresh manual
                        showRefreshButton();
                        return; // Salir despuÃ©s de cargar exitosamente
                    }
                } catch (e) {
                    console.log('â„¹ï¸ No se pudo cargar ' + fileName);
                }
            }
            console.log('â„¹ï¸ No se encontrÃ³ ningÃºn archivo JSON, usa el selector de archivo');
        }

        function showRefreshButton() {
            // Crear botÃ³n de refresh manual si no existe
            if (!document.getElementById('refreshBtn')) {
                const fileInput = document.getElementById('fileInput').parentElement;
                const btn = document.createElement('button');
                btn.id = 'refreshBtn';
                btn.className = 'ml-2 px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600';
                btn.innerHTML = 'ðŸ”„ Actualizar';
                btn.onclick = manualRefresh;
                fileInput.appendChild(btn);
            }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = 'â³ Cargando...';
            btn.disabled = true;
            
            await autoLoadTradesJson();
            
            btn.innerHTML = 'ðŸ”„ Actualizar';
            btn.disabled = false;
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    rawData = JSON.parse(e.target.result);
                    document.getElementById('dashboard').classList.remove('hidden');
                    runSimulation();
                } catch (err) { alert("Error al leer el archivo JSON."); }
            };
            reader.readAsText(file);
        });

        function getCaseSettings(caseId) {
            // C5 tiene su propia configuraciÃ³n
            if (caseId == 5) {
                let tp = (parseFloat(document.getElementById('tp_c5').value) || 0) / 100;
                const slEnabled = document.getElementById('sl_enabled_c5').checked;
                let sl = slEnabled ? (parseFloat(document.getElementById('sl_c5').value) || 0) / 100 : 0;
                if (tp > 0.618) tp = 0.618;
                if (sl > 0 && sl < 0.62) sl = 0.62;
                return { tp, sl, tpMax: 0.618, slMin: 0.62 };
            }
            
            let c = (caseId == 11) ? 1 : caseId;
            if (![1, 2, 3, 4].includes(c)) c = 1;

            let tp = (parseFloat(document.getElementById(`tp_c${c}`).value) || 0) / 100;
            
            // Verificar si SL estÃ¡ habilitado
            const slEnabled = document.getElementById(`sl_enabled_c${c}`).checked;
            let sl = slEnabled ? (parseFloat(document.getElementById(`sl_c${c}`).value) || 0) / 100 : 0;

            // Aplicar lÃ­mites segÃºn caso
            const limits = {
                1: { tpMax: 0.618, slMin: 0.62 },   // C1 y C1+: TP mÃ¡x 61.8%, SL mÃ­n 62%
                2: { tpMax: 0.618, slMin: 0.69 },   // C2: TP mÃ¡x 61.8%, SL mÃ­n 69%
                3: { tpMax: 0.786, slMin: 0.79 },   // C3: TP mÃ¡x 78.6%, SL mÃ­n 79%
                4: { tpMax: 0.75, slMin: 0.90 }     // C4: TP mÃ¡x 75%, SL mÃ­n 90%
            };

            const limit = limits[c] || limits[1];

            // Validar TP no exceda el mÃ¡ximo
            if (tp > limit.tpMax) tp = limit.tpMax;

            // Validar SL no sea menor que el mÃ­nimo (si SL > 0)
            if (sl > 0 && sl < limit.slMin) sl = limit.slMin;

            return { tp, sl, tpMax: limit.tpMax, slMin: limit.slMin };
        }

        function runSimulation() {
            if (!rawData) return;

            const minProfitReq = parseFloat(document.getElementById('filter_min_profit').value) || 0;
            const maxProfitReq = parseFloat(document.getElementById('filter_max_profit').value) || 0;
            const showIgnored = document.getElementById('showIgnored').checked;
            const cancelC1ppOnTP = document.getElementById('cancelC1ppOnTP').checked;
            
            // Obtener casos ignorados
            const ignoredCases = {
                1: document.getElementById('ignoreC1').checked,
                11: document.getElementById('ignoreC11').checked,
                2: document.getElementById('ignoreC2').checked,
                3: document.getElementById('ignoreC3').checked,
                4: document.getElementById('ignoreC4').checked,
                5: document.getElementById('ignoreC5').checked
            };

            // Estructura de Datos
            let stats = {
                realized: 0, floating: 0,
                wins: 0, losses: 0, closedTrades: 0, openTrades: 0,
                grossWin: 0, grossLoss: 0, ignored: 0, totalTrades: 0, ignoredByCase: 0,
                pfSum: 0, pfCount: 0  // Para promedio de PF
            };

            let caseStats = {};
            [1, 11, 2, 3, 4, 5].forEach(i => {
                caseStats[i] = {
                    total: 0, closed: 0, open: 0,
                    wins: 0, losses: 0,
                    realizedPnl: 0, floatingPnl: 0,
                    grossWin: 0, grossLoss: 0,
                    pfSum: 0, pfCount: 0  // Para promedio de PF por caso
                };
            });

            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';

            // 1. Unificar Trades
            let allTrades = [];
            // Historial
            if (rawData.history) rawData.history.forEach(t => {
                t._src = 'HIST';
                // Para HIST: usar precio mÃ¡ximo DURANTE la operaciÃ³n (pre-close)
                let impliedMaxDuring = t.max_price_pre_close || t.entry_price;
                // Para SL: usar SOLO el precio mÃ¡ximo DURANTE la operaciÃ³n
                t._max = impliedMaxDuring;
                
                // Para TP: usar el precio mÃ­nimo DURANTE y POST operaciÃ³n
                // Esto permite simular TPs mÃ¡s bajos que el original
                let impliedMinDuring = t.min_price_pre_close || t.entry_price;
                // Combinar el mÃ­nimo durante operaciÃ³n con el mÃ­nimo post-close
                let minPostClose = t.min_price_post_close || t.close_price;
                t._min = Math.min(impliedMinDuring, t.close_price, minPostClose);
                
                allTrades.push(t);
            });
            // Abiertas
            if (rawData.open_positions) Object.values(rawData.open_positions).forEach(t => {
                t._src = 'OPEN';
                
                // Usar current_price vÃ¡lido, o entry_price como fallback
                const effectivePrice = (t.current_price && t.current_price > 0) ? t.current_price : t.entry_price;
                
                // Usar max_price_pre_close para el precio mÃ¡ximo alcanzado
                let impliedMax = t.max_price_pre_close || t.entry_price;
                t._max = Math.max(impliedMax, effectivePrice);

                // Usar min_price_pre_close para el precio mÃ­nimo alcanzado
                let impliedMin = t.min_price_pre_close || t.entry_price;
                t._min = Math.min(impliedMin, effectivePrice);

                if (!t.fib_high) t.fib_high = t.entry_price * 1.05;
                if (!t.fib_low) t.fib_low = t.entry_price * 0.95;
                allTrades.push(t);
            });

            // 1.5. Pre-procesar: Detectar sÃ­mbolos donde C2/C3/C4 tocÃ³ TP (para cancelar C1++ asociado)
            let symbolsWithTPHit = new Set();
            if (cancelC1ppOnTP) {
                allTrades.forEach(t => {
                    const cID = t.strategy_case || 1;
                    // Solo procesar C2, C3, C4 (no C1 ni C1++)
                    if (cID >= 2 && cID <= 4) {
                        const s = getCaseSettings(cID);
                        const range = t.fib_high - t.fib_low;
                        const tpPrice = t.fib_low + (range * s.tp);
                        // Verificar si tocÃ³ TP
                        const hitTP = t._min <= tpPrice;
                        if (hitTP) {
                            symbolsWithTPHit.add(t.symbol);
                        }
                    }
                });
            }

            // 1.6. DETECTAR CASO 5 (Promediado): C2/C3/C4 + C1++ del mismo sÃ­mbolo que se fusionan
            // CondiciÃ³n: 1) El SL del C2/C3/C4 >= entry del C1++
            //            2) Ambos trades llegaron a ejecutarse
            //            3) El mainTrade NO cerrÃ³ en TP antes de que C1++ se ejecute
            let c5Trades = [];  // Trades C5 sintÃ©ticos
            let tradesConvertedToC5 = new Set();  // order_ids que se fusionaron en C5
            const enableC5Averaging = document.getElementById('enableC5Averaging') ? document.getElementById('enableC5Averaging').checked : true;
            
            if (enableC5Averaging) {
                // Agrupar trades por sÃ­mbolo
                let tradesBySymbol = {};
                allTrades.forEach(t => {
                    const sym = t.symbol;
                    if (!tradesBySymbol[sym]) tradesBySymbol[sym] = [];
                    tradesBySymbol[sym].push(t);
                });
                
                // Para cada sÃ­mbolo, buscar pares C2/C3/C4 + C1++
                for (const symbol in tradesBySymbol) {
                    const symTrades = tradesBySymbol[symbol];
                    
                    // Buscar C2/C3/C4 (principal) y C1++ (complementario)
                    const mainTrades = symTrades.filter(t => [2, 3, 4].includes(t.strategy_case));
                    const c1ppTrades = symTrades.filter(t => t.strategy_case === 11);
                    
                    if (mainTrades.length === 0 || c1ppTrades.length === 0) continue;
                    
                    // Para cada par principal + C1++
                    mainTrades.forEach(mainTrade => {
                        c1ppTrades.forEach(c1ppTrade => {
                            // 1. Calcular entry del C1++
                            const c1ppRange = c1ppTrade.fib_high - c1ppTrade.fib_low;
                            const c1ppEntry = c1ppTrade.fib_low + (c1ppRange * 0.618);
                            
                            // 2. Verificar si el SL del trade principal estÃ¡ >= al entry del C1++
                            const mainCaseSettings = getCaseSettings(mainTrade.strategy_case);
                            const mainRange = mainTrade.fib_high - mainTrade.fib_low;
                            const mainSL = mainTrade.fib_low + (mainRange * mainCaseSettings.sl);
                            
                            // Si SL < entry C1++, no se fusionan (el SL se ejecutarÃ­a antes)
                            if (mainSL < c1ppEntry) return;
                            
                            // 3. Verificar si mainTrade cerrÃ³ en TP ANTES de que C1++ se ejecutara
                            const mainTP = mainTrade.fib_low + (mainRange * mainCaseSettings.tp);
                            const mainHitTP = mainTrade._min <= mainTP;
                            
                            // Si mainTrade cerrÃ³ en TP, C1++ se cancela (no se fusionan)
                            if (mainHitTP) return;
                            
                            // 4. Verificar si el precio subiÃ³ hasta el entry del C1++ (C1++ se ejecutÃ³)
                            const c1ppExecuted = mainTrade._max >= c1ppEntry;
                            if (!c1ppExecuted) return;
                            
                            // Â¡SE FUSIONAN EN C5!
                            // Calcular precio promediado ponderado
                            const mainQty = mainTrade.quantity || 1;
                            const c1ppQty = c1ppTrade.quantity || 1;
                            const avgEntry = (mainTrade.entry_price * mainQty + c1ppEntry * c1ppQty) / (mainQty + c1ppQty);
                            
                            // Crear trade C5 sintÃ©tico (hereda niveles Fib del C1++)
                            const c5Trade = {
                                ...c1ppTrade,  // Hereda la mayorÃ­a del C1++
                                symbol: symbol,
                                strategy_case: 5,
                                entry_price: avgEntry,
                                quantity: mainQty + c1ppQty,
                                margin: (mainTrade.margin || 2) + (c1ppTrade.margin || 2),
                                _src: mainTrade._src,
                                _max: Math.max(mainTrade._max, c1ppTrade._max || 0),
                                _min: Math.min(mainTrade._min, c1ppTrade._min || Infinity),
                                // Componentes originales para referencia
                                _mainTrade: mainTrade,
                                _c1ppTrade: c1ppTrade,
                                _avgExplanation: `Avg: $${mainTrade.entry_price.toFixed(4)} (${mainQty.toFixed(2)}) + $${c1ppEntry.toFixed(4)} (${c1ppQty.toFixed(2)})`
                            };
                            
                            c5Trades.push(c5Trade);
                            tradesConvertedToC5.add(mainTrade.order_id);
                            tradesConvertedToC5.add(c1ppTrade.order_id);
                        });
                    });
                }
                
                // Filtrar trades que se convirtieron en C5
                allTrades = allTrades.filter(t => !tradesConvertedToC5.has(t.order_id));
                // Agregar los C5 sintÃ©ticos
                allTrades = allTrades.concat(c5Trades);
            }
            
            // Actualizar contador de C5
            document.getElementById('c5_count').textContent = c5Trades.length;

            // 2. Procesar trades y almacenar datos para renderizado
            let processedTrades = [];
            let ignoredTrades = [];
            
            allTrades.forEach(t => {
                stats.totalTrades++;
                let cID = t.strategy_case || 1;
                // Mantener case 11 separado, no mapear a 1
                if (!caseStats[cID]) cID = 1;
                
                // Verificar si C1++ debe cancelarse porque su C2/C3/C4 asociado tocÃ³ TP
                if (cancelC1ppOnTP && cID === 11 && symbolsWithTPHit.has(t.symbol)) {
                    stats.ignoredByCase++;
                    if (showIgnored) {
                        const s = getCaseSettings(cID);
                        const range = t.fib_high - t.fib_low;
                        const tpPrice = t.fib_low + (range * s.tp);
                        let slPrice = Infinity;
                        if (s.sl > 0) slPrice = t.fib_low + (range * s.sl);
                        
                        ignoredTrades.push({
                            t, cID, s, tpPrice, slPrice, slIsValid: true,
                            status: "CANCELADO (TP HIT) ðŸŸ£", 
                            rPnl: 0, fPnl: 0, 
                            css: "bg-purple-100", 
                            tradePF: '-', pfDisplay: '-', 
                            rrDisplay: '-', rrValue: 0,
                            potProfit: 0,
                            isIgnored: true,
                            cancelReason: 'tp_hit'
                        });
                    }
                    return;
                }
                
                // Verificar si el caso estÃ¡ ignorado
                if (ignoredCases[cID]) {
                    stats.ignoredByCase++;
                    if (showIgnored) {
                        const s = getCaseSettings(cID);
                        const range = t.fib_high - t.fib_low;
                        const tpPrice = t.fib_low + (range * s.tp);
                        let slPrice = Infinity;
                        if (s.sl > 0) slPrice = t.fib_low + (range * s.sl);
                        
                        ignoredTrades.push({
                            t, cID, s, tpPrice, slPrice, slIsValid: true,
                            status: "CASO IGNORADO ðŸš«", 
                            rPnl: 0, fPnl: 0, 
                            css: "bg-ignored", 
                            tradePF: '-', pfDisplay: '-', 
                            rrDisplay: '-', rrValue: 0,
                            potProfit: 0,
                            isIgnored: true
                        });
                    }
                    return;
                }

                const s = getCaseSettings(cID);
                const range = t.fib_high - t.fib_low;

                const tpPrice = t.fib_low + (range * s.tp);
                let slPrice = Infinity;
                if (s.sl > 0) slPrice = t.fib_low + (range * s.sl);

                // Check Filtros (Ganancia Potencial al TP)
                const potProfit = (t.entry_price - tpPrice) * t.quantity;
                const isIgnored = potProfit < minProfitReq || (maxProfitReq > 0 && potProfit > maxProfitReq);
                
                if (isIgnored) {
                    stats.ignored++;
                    if (showIgnored) {
                        ignoredTrades.push({
                            t, cID, s, tpPrice, slPrice, slIsValid: true,
                            status: "IGNORADO ðŸš«", 
                            rPnl: 0, fPnl: 0, 
                            css: "bg-ignored", 
                            tradePF: '-', pfDisplay: '-', 
                            rrDisplay: '-', rrValue: 0,
                            potProfit: potProfit,
                            isIgnored: true
                        });
                    }
                    return;
                }

                // LÃ³gica SimulaciÃ³n
                let status = "", rPnl = 0, fPnl = 0, css = "";
                let isClosed = false;
                let tradePF = 0;  // Profit Factor por operaciÃ³n

                // Prioridad: 1. SL Hit (Pesimista), 2. TP Hit, 3. Manual/Running
                // VALIDAR SL: Para SHORT, SL debe estar ARRIBA del entry (slPrice > entry_price)
                // Si SL estÃ¡ debajo del entry, es invÃ¡lido y se ignora
                const slIsValid = slPrice > t.entry_price;
                const hitSL = (s.sl > 0) && slIsValid && (t._max >= slPrice);
                const hitTP = t._min <= tpPrice;

                // Calcular pÃ©rdida potencial al SL para PF (solo si SL es vÃ¡lido)
                const potLoss = (s.sl > 0 && slIsValid) ? Math.abs((slPrice - t.entry_price) * t.quantity) : 0;

                if (hitSL) {
                    // Cierra por SL (Realized Loss)
                    status = "SL HIT âŒ";
                    rPnl = (t.entry_price - slPrice) * t.quantity;
                    isClosed = true;
                    css = "bg-loss";
                    tradePF = 0;  // PÃ©rdida = PF 0
                } else if (hitTP) {
                    // Cierra por TP (Realized Win)
                    status = "TP HIT âœ…";
                    rPnl = potProfit;
                    isClosed = true;
                    css = "bg-win";
                    // PF = Ganancia / Riesgo (pÃ©rdida potencial al SL)
                    tradePF = potLoss > 0 ? (potProfit / potLoss) : (potProfit > 0 ? Infinity : 0);
                } else {
                    // No tocÃ³ limites nuevos
                    if (t._src === 'HIST') {
                        // Ya cerrÃ³ manualmente en historial
                        status = "MANUAL CLOSED";
                        rPnl = t.pnl; // PnL original
                        isClosed = true;
                        css = "bg-neutral";
                        tradePF = potLoss > 0 ? (Math.abs(rPnl) / potLoss) : 0;
                        if (rPnl < 0) tradePF = 0;  // Si fue pÃ©rdida, PF = 0
                    } else {
                        // Sigue abierta
                        status = "RUNNING â³";
                        fPnl = (t.entry_price - t.current_price) * t.quantity; // Flotante actual
                        isClosed = false;
                        css = "bg-run";
                        tradePF = '-';  // No cerrada, sin PF
                    }
                }

                // Acumuladores
                caseStats[cID].total++;
                if (isClosed) {
                    stats.closedTrades++;
                    stats.realized += rPnl;

                    caseStats[cID].closed++;
                    caseStats[cID].realizedPnl += rPnl;

                    if (rPnl > 0) {
                        stats.wins++; stats.grossWin += rPnl;
                        caseStats[cID].wins++; caseStats[cID].grossWin += rPnl;
                        // Sumar PF para promedios (solo ganadores con PF finito)
                        if (typeof tradePF === 'number' && isFinite(tradePF)) {
                            stats.pfSum += tradePF;
                            stats.pfCount++;
                            caseStats[cID].pfSum += tradePF;
                            caseStats[cID].pfCount++;
                        }
                    } else {
                        stats.losses++; stats.grossLoss += Math.abs(rPnl);
                        caseStats[cID].losses++; caseStats[cID].grossLoss += Math.abs(rPnl);
                    }
                } else {
                    stats.openTrades++;
                    stats.floating += fPnl;

                    caseStats[cID].open++;
                    caseStats[cID].floatingPnl += fPnl;
                }

                // Formatear PF para mostrar
                let pfDisplay = '-';
                if (typeof tradePF === 'number') {
                    pfDisplay = isFinite(tradePF) ? tradePF.toFixed(2) : 'âˆž';
                }

                // Calcular R:R (Risk:Reward) - Riesgo (distancia a SL) vs Beneficio (distancia a TP)
                // Solo calcular si SL es vÃ¡lido (arriba del entry para SHORT)
                const riskDistance = (s.sl > 0 && slIsValid) ? Math.abs(slPrice - t.entry_price) : 0;
                const rewardDistance = Math.abs(t.entry_price - tpPrice);
                let rrDisplay = '-';
                let rrValue = 0;
                if (riskDistance > 0 && rewardDistance > 0) {
                    rrValue = rewardDistance / riskDistance;
                    rrDisplay = `1:${rrValue.toFixed(2)}`;
                } else if (rewardDistance > 0) {
                    rrDisplay = '1:âˆž';
                    rrValue = Infinity;
                }

                // Almacenar datos procesados para ordenamiento
                processedTrades.push({
                    t, cID, s, tpPrice, slPrice, slIsValid, status, rPnl, fPnl, css, tradePF, pfDisplay, rrDisplay, rrValue, isIgnored: false
                });
            });

            // 3. Ordenar segÃºn prioridad de caso o por PnL
            if (sortMode === 'pnl_real') {
                // Ordenar por PnL Realizado (mayor a menor)
                processedTrades.sort((a, b) => b.rPnl - a.rPnl);
            } else if (sortMode === 'pnl_float') {
                // Ordenar por PnL Flotante (mayor a menor)
                processedTrades.sort((a, b) => b.fPnl - a.fPnl);
            } else if (casePriority !== 0) {
                // Mostrar primero el caso seleccionado
                processedTrades.sort((a, b) => {
                    const aIsPriority = a.cID === casePriority ? 0 : 1;
                    const bIsPriority = b.cID === casePriority ? 0 : 1;
                    return aIsPriority - bIsPriority;
                });
            }

            // AÃ±adir trades ignorados al final si showIgnored estÃ¡ activo
            if (showIgnored && ignoredTrades.length > 0) {
                processedTrades = processedTrades.concat(ignoredTrades);
            }

            // 4. Renderizar tabla
            processedTrades.forEach(({ t, cID, s, tpPrice, slPrice, slIsValid, status, rPnl, fPnl, css, tradePF, pfDisplay, rrDisplay, rrValue, isIgnored, potProfit }) => {
                const caseDisplay = t.strategy_case == 11 ? 'C1++' : (t.strategy_case == 5 ? 'C5' : `C${t.strategy_case}`);
                const rowClassBase = t.strategy_case == 5 ? 'row-c5' : (t.strategy_case == 11 ? 'row-c11' : `row-c${t.strategy_case || 1}`);
                const rowClass = isIgnored ? `${rowClassBase} row-ignored` : rowClassBase;
                // Mostrar SL con indicador si es invÃ¡lido (SL debajo del entry)
                const slDisplay = s.sl > 0 
                    ? (slIsValid !== false ? slPrice.toFixed(4) : `${slPrice.toFixed(4)} âš ï¸`) 
                    : 'âˆž';
                // Para C5, mostrar entrada promediada con tooltip
                const entryDisplay = t.strategy_case == 5 && t._avgExplanation 
                    ? `<span title="${t._avgExplanation}" style="cursor: help;">${t.entry_price.toFixed(5)} ðŸ“Š</span>`
                    : t.entry_price.toFixed(5);
                
                // Badge styles for cases
                const caseBadgeStyle = t.strategy_case == 5 
                    ? 'background: rgba(168, 85, 247, 0.2); color: var(--accent-purple); border: 1px solid rgba(168, 85, 247, 0.4);'
                    : t.strategy_case == 11 
                        ? 'background: rgba(56, 189, 248, 0.2); color: #38bdf8; border: 1px solid rgba(56, 189, 248, 0.4);'
                        : 'background: rgba(100, 116, 139, 0.2); color: var(--text-secondary); border: 1px solid rgba(100, 116, 139, 0.3);';
                
                // Source badge style
                const srcBadgeStyle = t._src === 'OPEN' 
                    ? 'background: rgba(0, 212, 255, 0.15); color: var(--accent-blue); border: 1px solid rgba(0, 212, 255, 0.3);'
                    : 'background: rgba(100, 116, 139, 0.2); color: var(--text-muted); border: 1px solid rgba(100, 116, 139, 0.3);';
                
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td><span class="badge" style="${srcBadgeStyle}">${t._src}</span></td>
                        <td class="font-bold">${t.symbol}</td>
                        <td class="text-center"><span class="badge" style="${caseBadgeStyle}">${caseDisplay}</span></td>
                        <td class="text-slate-400">${entryDisplay}</td>
                        <td class="text-center text-[11px]">
                            <div style="color: var(--accent-green)">TP: ${tpPrice.toFixed(4)}</div>
                            <div style="color: var(--accent-red)">SL: ${slDisplay}</div>
                        </td>
                        <td class="text-center"><span class="badge ${css}">${status}${isIgnored ? ` ($${potProfit.toFixed(2)})` : ''}</span></td>
                        <td class="text-center font-mono font-bold" style="color: ${rrValue >= 1 ? 'var(--accent-green)' : 'var(--accent-yellow)'}">${rrDisplay}</td>
                        <td class="text-center font-mono font-bold" style="color: ${typeof tradePF === 'number' && tradePF > 1 ? 'var(--accent-green)' : 'var(--text-muted)'}">${pfDisplay}</td>
                        <td class="text-right font-mono font-bold" style="color: ${rPnl === 0 ? 'var(--text-muted)' : (rPnl > 0 ? 'var(--accent-green)' : 'var(--accent-red)')}">${rPnl !== 0 ? rPnl.toFixed(2) : '-'}</td>
                        <td class="text-right font-mono font-bold" style="color: ${fPnl === 0 ? 'var(--text-muted)' : (fPnl > 0 ? 'var(--accent-blue)' : 'var(--accent-orange)')}">${fPnl !== 0 ? fPnl.toFixed(2) : '-'}</td>
                    </tr>
                `;
            });

            // 5. Renderizar Tabla por Caso - Incluyendo C1++ (caso 11) y C5 separado
            const caseBody = document.getElementById('casesTableBody');
            caseBody.innerHTML = '';
            const caseOrder = [1, 11, 2, 3, 4, 5];  // Orden de casos incluyendo C1++ (11) y C5
            const caseNames = { 1: 'Caso 1', 11: 'Caso 1++', 2: 'Caso 2', 3: 'Caso 3', 4: 'Caso 4', 5: 'Caso 5 (Avg)' };

            caseOrder.forEach(i => {
                const s = caseStats[i];
                if (s.total === 0) return;

                const wr = s.closed > 0 ? ((s.wins / s.closed) * 100).toFixed(1) + '%' : '-';
                // PF promedio por caso (solo de trades ganadores)
                const pfAvg = s.pfCount > 0 ? (s.pfSum / s.pfCount).toFixed(2) : '-';
                const totalC = s.realizedPnl + s.floatingPnl;

                const caseRowClass = i === 5 ? 'row-c5' : (i === 11 ? 'row-c11' : `row-c${i}`);
                caseBody.innerHTML += `
                    <tr class="${caseRowClass}">
                        <td class="font-bold" style="color: ${i === 1 ? 'var(--accent-blue)' : i === 11 ? '#38bdf8' : i === 2 ? 'var(--accent-yellow)' : i === 3 ? 'var(--accent-orange)' : i === 4 ? 'var(--accent-red)' : 'var(--accent-purple)'}">${caseNames[i]}</td>
                        <td class="text-center">${s.closed} <span class="text-slate-500 text-xs">/ ${s.total}</span></td>
                        <td class="text-center font-bold" style="color: var(--accent-blue)">${wr}</td>
                        <td class="text-center font-mono font-bold" style="color: var(--accent-purple)">${pfAvg}</td>
                        <td class="text-right font-bold" style="color: ${s.realizedPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${s.realizedPnl.toFixed(2)}</td>
                        <td class="text-right font-bold" style="color: ${s.floatingPnl >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)'}">$${s.floatingPnl.toFixed(2)}</td>
                        <td class="text-right font-black" style="color: ${totalC >= 0 ? 'var(--text-primary)' : 'var(--accent-red)'}">$${totalC.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Fila de TOTAL/PROMEDIO GENERAL
            const totalRealizedAll = Object.values(caseStats).reduce((sum, s) => sum + s.realizedPnl, 0);
            const totalFloatingAll = Object.values(caseStats).reduce((sum, s) => sum + s.floatingPnl, 0);
            const totalAll = totalRealizedAll + totalFloatingAll;
            const pfAvgGeneral = stats.pfCount > 0 ? (stats.pfSum / stats.pfCount).toFixed(2) : '-';

            caseBody.innerHTML += `
                <tr style="background: linear-gradient(90deg, rgba(0, 212, 255, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%); font-weight: bold;">
                    <td class="font-black" style="color: var(--accent-blue)">ðŸ“Š TOTAL</td>
                    <td class="text-center">${stats.closedTrades} <span class="text-slate-400 text-xs">/ ${stats.closedTrades + stats.openTrades}</span></td>
                    <td class="text-center" style="color: var(--accent-blue)">${stats.closedTrades > 0 ? ((stats.wins / stats.closedTrades) * 100).toFixed(1) : 0}%</td>
                    <td class="text-center font-mono" style="color: var(--accent-purple)">${pfAvgGeneral}</td>
                    <td class="text-right" style="color: ${totalRealizedAll >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${totalRealizedAll.toFixed(2)}</td>
                    <td class="text-right" style="color: ${totalFloatingAll >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)'}">$${totalFloatingAll.toFixed(2)}</td>
                    <td class="text-right font-black" style="color: ${totalAll >= 0 ? 'var(--text-primary)' : 'var(--accent-red)'}">$${totalAll.toFixed(2)}</td>
                </tr>
            `;

            // 4. KPIs Globales
            const gWR = stats.closedTrades > 0 ? ((stats.wins / stats.closedTrades) * 100).toFixed(1) + '%' : '0%';
            const gPF = stats.grossLoss > 0 ? (stats.grossWin / stats.grossLoss).toFixed(2) : (stats.grossWin > 0 ? 'âˆž' : '0.00');
            const gTotal = stats.realized + stats.floating;

            document.getElementById('kpi_realized_pnl').innerText = `$${stats.realized.toFixed(2)}`;
            document.getElementById('kpi_realized_pnl').className = `kpi-value mt-2 ${stats.realized >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('kpi_floating_pnl').innerText = `$${stats.floating.toFixed(2)}`;
            document.getElementById('kpi_floating_pnl').className = `kpi-value mt-2`;
            document.getElementById('kpi_floating_pnl').style.color = stats.floating >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)';

            document.getElementById('kpi_total_pnl').innerText = `$${gTotal.toFixed(2)}`;
            document.getElementById('kpi_total_pnl').className = `kpi-value mt-2 ${gTotal >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('kpi_winrate').innerText = gWR;
            document.getElementById('kpi_trades_info').innerText = `${stats.closedTrades} / ${stats.totalTrades || stats.closedTrades + stats.openTrades}`;

            document.getElementById('kpi_pf').innerText = gPF;
            const totalIgnored = stats.ignored + stats.ignoredByCase;
            let ignoredDetails = [];
            if (stats.ignoredByCase > 0) ignoredDetails.push(`${stats.ignoredByCase} caso`);
            if (stats.ignored > 0) ignoredDetails.push(`${stats.ignored} filtro`);
            document.getElementById('filter_stats_text').innerText = `Ignoradas: ${totalIgnored} de ${stats.totalTrades}${ignoredDetails.length ? ' (' + ignoredDetails.join(', ') + ')' : ''}`;
        }
    </script>
</body>

</html>