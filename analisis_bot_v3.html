<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Pro V2 - Trading Bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Lightweight Charts para el gr√°fico -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --bg-card-hover: #1c2951;
            --accent-blue: #00d4ff;
            --accent-purple: #a855f7;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #fbbf24;
            --accent-orange: #f97316;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255, 255, 255, 0.08);
            --glow-blue: rgba(0, 212, 255, 0.3);
            --glow-purple: rgba(168, 85, 247, 0.3);
            --glow-green: rgba(34, 197, 94, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0d1b2a 100%);
            font-family: 'Inter', 'Segoe UI', sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(34, 197, 94, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        .card {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.8) 100%);
            border-radius: 16px;
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 0 40px rgba(0, 212, 255, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            padding: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 30px rgba(0, 0, 0, 0.4),
                0 0 50px rgba(0, 212, 255, 0.05);
        }

        .card-glow-blue {
            border-top: 2px solid var(--accent-blue);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 -5px 30px var(--glow-blue);
        }

        .card-glow-green {
            border-top: 2px solid var(--accent-green);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 -5px 30px var(--glow-green);
        }

        .card-glow-purple {
            border-top: 2px solid var(--accent-purple);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 -5px 30px var(--glow-purple);
        }

        .input-dense {
            padding: 8px 12px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .input-dense:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 3px var(--glow-blue);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.70rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .bg-win {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .bg-loss {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .bg-run {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 212, 255, 0.1) 100%);
            color: var(--accent-blue);
            border: 1px solid rgba(0, 212, 255, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            }
        }

        .bg-neutral {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-secondary);
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .bg-ignored {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(251, 191, 36, 0.1) 100%);
            color: var(--accent-yellow);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        /* Headers para separar secciones */
        .section-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent-blue);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 2px;
        }

        /* Estilos para sliders */
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .slider-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-blue);
            text-align: right;
            text-shadow: 0 0 10px var(--glow-blue);
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            outline: none;
            border: 1px solid var(--border-color);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            cursor: pointer;
            box-shadow: 0 0 15px var(--glow-blue);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px var(--glow-blue);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 15px var(--glow-blue);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(100, 116, 139, 0.3);
            transition: 0.4s;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked+.toggle-slider {
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        .sl-disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Bot√≥n reset individual */
        .reset-btn {
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }

        .reset-btn:hover {
            color: var(--accent-blue);
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 10px var(--glow-blue);
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Botones de precisi√≥n < > */
        .precision-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .precision-btn {
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .precision-btn:hover {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 0 15px var(--glow-blue);
            transform: scale(1.1);
        }

        .precision-btn:active {
            transform: scale(0.95);
        }

        .slider-with-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .slider-with-controls input[type="range"] {
            flex: 1;
        }

        /* Case panels styling */
        .case-panel {
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .case-panel:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .case-panel.case-1 {
            border-left: 3px solid var(--accent-blue);
        }

        .case-panel.case-1pp {
            border-left: 3px solid #38bdf8;
        }

        .case-panel.case-2 {
            border-left: 3px solid var(--accent-yellow);
        }

        .case-panel.case-3 {
            border-left: 3px solid var(--accent-orange);
        }

        .case-panel.case-4 {
            border-left: 3px solid var(--accent-red);
        }

        /* KPI Cards */
        .kpi-card {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.6) 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .kpi-card.kpi-blue::before {
            background: var(--accent-blue);
        }

        .kpi-card.kpi-green::before {
            background: var(--accent-green);
        }

        .kpi-card.kpi-purple::before {
            background: var(--accent-purple);
        }

        .kpi-card.kpi-gray::before {
            background: var(--text-muted);
        }

        .kpi-value {
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .kpi-value.positive {
            background: linear-gradient(135deg, var(--accent-green) 0%, #86efac 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .kpi-value.negative {
            background: linear-gradient(135deg, var(--accent-red) 0%, #fca5a5 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Table styling */
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .modern-table thead {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.2) 100%);
        }

        .modern-table th {
            padding: 14px 16px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }

        .modern-table td {
            padding: 12px 16px;
            font-size: 0.85rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .modern-table tbody tr {
            transition: all 0.2s;
            cursor: pointer;
        }

        .modern-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .modern-table tbody tr.selected {
            background: rgba(0, 212, 255, 0.2) !important;
            box-shadow: inset 0 0 0 2px var(--accent-blue);
        }

        .modern-table tbody tr.row-c1 {
            border-left: 3px solid var(--accent-blue);
        }

        .modern-table tbody tr.row-c11 {
            border-left: 3px solid #38bdf8;
            background: rgba(56, 189, 248, 0.05);
        }

        .modern-table tbody tr.row-c2 {
            border-left: 3px solid var(--accent-yellow);
        }

        .modern-table tbody tr.row-c3 {
            border-left: 3px solid var(--accent-orange);
        }

        .modern-table tbody tr.row-c4 {
            border-left: 3px solid var(--accent-red);
        }

        .modern-table tbody tr.row-ignored {
            opacity: 0.5;
        }

        /* Filter buttons */
        .filter-btn {
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 20px var(--glow-blue);
        }

        .filter-btn.btn-c1:hover,
        .filter-btn.btn-c1.active {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .filter-btn.btn-c2:hover,
        .filter-btn.btn-c2.active {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .filter-btn.btn-c3:hover,
        .filter-btn.btn-c3.active {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .filter-btn.btn-c4:hover,
        .filter-btn.btn-c4.active {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 15px var(--glow-blue);
        }

        .file-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--glow-blue);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            border-color: transparent;
            box-shadow: 0 0 10px var(--glow-blue);
        }

        input[type="checkbox"]:checked::after {
            content: '‚úì';
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Header styling */
        .main-header {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.8) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 28px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .main-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-title span {
            -webkit-text-fill-color: var(--accent-blue);
        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* ========== NUEVO: Chart Panel ========== */
        .chart-panel {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.8) 100%);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .chart-symbol {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .chart-timeframe-btns {
            display: flex;
            gap: 6px;
        }

        .tf-btn {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tf-btn:hover,
        .tf-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        #chartContainer {
            flex: 1;
            min-height: 400px;
        }

        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
        }

        .chart-placeholder-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .chart-info {
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 11px;
        }

        .chart-info-item {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chart-info-label {
            color: var(--text-muted);
        }

        .chart-info-value {
            font-weight: 600;
        }

        /* Mode Switch (Analizador / Visor) */
        .mode-switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .mode-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .mode-label.active {
            color: var(--accent-blue);
            text-shadow: 0 0 10px var(--glow-blue);
        }

        .mode-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .mode-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .mode-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            transition: 0.4s;
            border-radius: 26px;
        }

        .mode-switch .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .mode-switch input:checked+.slider {
            background: linear-gradient(135deg, var(--accent-green) 0%, #16a34a 100%);
        }

        .mode-switch input:checked+.slider:before {
            transform: translateX(24px);
        }

        /* Bot√≥n Descargar MV */
        .download-mv-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 10px;
            color: var(--accent-purple);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .download-mv-btn:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3) 0%, rgba(0, 212, 255, 0.2) 100%);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
            transform: translateY(-2px);
        }

        .download-mv-btn:active {
            transform: scale(0.98);
        }

        .download-mv-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>

<body class="p-4">
    <div class="max-w-screen-2xl mx-auto space-y-4">

        <!-- Header -->
        <div class="main-header flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="main-title">üöÄ Simulador Trading Bot <span>V3</span></h1>
                <p class="text-sm text-slate-400 mt-1">An√°lisis profesional con gr√°fico integrado</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Mode Switch -->
                <div class="mode-switch-container">
                    <span class="mode-label active" id="modeLabelAnalyzer">üìä Analizador</span>
                    <label class="mode-switch">
                        <input type="checkbox" id="modeSwitch" onchange="switchMode()">
                        <span class="slider"></span>
                    </label>
                    <span class="mode-label" id="modeLabelVisor">üëÅÔ∏è Visor</span>
                </div>
                <!-- File input -->
                <div class="file-input-wrapper">
                    <button class="file-input-btn">üìÇ Cargar JSON</button>
                    <input type="file" id="fileInput" accept=".json" />
                </div>
                <button id="refreshBtn" class="hidden px-4 py-2 text-sm font-semibold rounded-lg transition-all"
                    style="background: rgba(0, 212, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue);"
                    onclick="manualRefresh()">üîÑ Actualizar</button>
            </div>
        </div>

        <div id="dashboard" class="hidden animate-in">
            <!-- Layout principal: arriba config + KPIs, abajo tabla + gr√°fico -->

            <!-- FILA SUPERIOR: Config + KPIs -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-4 mb-4">
                <!-- CONFIG EN MATRIZ 2x3 (6 columnas) -->
                <div class="xl:col-span-7">
                    <div class="card card-glow-blue p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="section-header mb-0 text-xs">Config. por Caso</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="resetDefaults()"
                                    class="text-xs text-cyan-400 hover:text-cyan-300 transition-colors font-medium">‚ü≤
                                    Reiniciar</button>
                            </div>
                        </div>

                        <!-- Matriz 2x3 de casos -->
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                            <!-- C1 -->
                            <div class="case-panel case-1 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-blue)">‚ö° C1</div>
                                    <div class="flex items-center gap-1">
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c1"
                                                onchange="toggleSL(1); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">(m√°x
                                                61)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c1', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c1" value="51" min="0" max="61" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c1', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c1', 51)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c1_val">51</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c1">
                                        <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">(m√≠n
                                                62)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c1', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c1" value="67" min="62" max="200" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c1', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c1', 67)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c1_val">67</span>
                                    </div>
                                </div>
                            </div>

                            <!-- C2 -->
                            <div class="case-panel case-2 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-yellow)">üìä C2</div>
                                    <div class="flex items-center gap-1">
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c2"
                                                onchange="toggleSL(2); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">(m√°x
                                                61)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c2', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c2" value="50" min="0" max="61" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c2', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c2', 50)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c2_val">50</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c2">
                                        <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">(m√≠n
                                                65)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c2', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c2" value="82" min="65" max="200" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c2', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c2', 82)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c2_val">82</span>
                                    </div>
                                </div>
                            </div>
                            <!-- C3 -->
                            <div class="case-panel case-3 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-orange)">üî• C3</div>
                                    <div class="flex items-center gap-1">
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c3"
                                                onchange="toggleSL(3); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">(m√°x
                                                78)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c3', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c3" value="61" min="0" max="78" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c3', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c3', 61)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c3_val">61</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c3">
                                        <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">(m√≠n
                                                79)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c3', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c3" value="92" min="79" max="200" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c3', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c3', 92)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c3_val">92</span>
                                    </div>
                                </div>
                            </div>
                            <!-- C4 -->
                            <div class="case-panel case-4 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-red)">üíé C4</div>
                                    <div class="flex items-center gap-1">
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c4"
                                                onchange="toggleSL(4); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">(m√°x
                                                78)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c4', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c4" value="50" min="0" max="78" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c4', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c4', 50)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c4_val">50</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c4">
                                        <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">(m√≠n
                                                90)</span></label>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c4', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c4" value="95" min="90" max="200" step="1"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c4', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c4', 95)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c4_val">95</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filtros de Ganancia (dentro del mismo card) -->
                        <div class="mt-3 pt-3 border-t border-slate-700/30">
                            <h4 class="text-[10px] text-slate-400 font-semibold uppercase mb-2">Filtros Ganancia ($)
                            </h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="slider-container">
                                    <label class="text-[9px] text-slate-400">M√≠nima</label>
                                    <div class="flex items-center gap-1">
                                        <button type="button" onclick="adjustSlider('filter_min_profit', -1)"
                                            class="precision-btn">&lt;</button>
                                        <input type="range" id="filter_min_profit" value="0" min="0" max="5" step="0.1"
                                            oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                        <button type="button" onclick="adjustSlider('filter_min_profit', 1)"
                                            class="precision-btn">&gt;</button>
                                        <button type="button" onclick="resetSlider('filter_min_profit', 0)"
                                            class="reset-btn" title="Reset">‚Ü∫</button>
                                    </div>
                                    <span class="slider-value text-xs" id="filter_min_profit_val"
                                        style="color: var(--accent-green);">0.0</span>
                                </div>
                                <div class="slider-container">
                                    <label class="text-[9px] text-slate-400">M√°xima</label>
                                    <div class="flex items-center gap-1">
                                        <button type="button" onclick="adjustSlider('filter_max_profit', -1)"
                                            class="precision-btn">&lt;</button>
                                        <input type="range" id="filter_max_profit" value="0" min="0" max="5" step="0.1"
                                            oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                        <button type="button" onclick="adjustSlider('filter_max_profit', 1)"
                                            class="precision-btn">&gt;</button>
                                        <button type="button" onclick="resetSlider('filter_max_profit', 0)"
                                            class="reset-btn" title="Reset">‚Ü∫</button>
                                    </div>
                                    <span class="slider-value text-xs" id="filter_max_profit_val"
                                        style="color: var(--accent-green);">0.0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPIs + Rendimiento por Caso (5 columnas a la derecha) -->
                <div class="xl:col-span-5 space-y-3">
                    <!-- KPIs -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-1">
                        <div class="kpi-card kpi-blue p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">PnL Realizado</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_realized_pnl">$0.00</div>
                        </div>
                        <div class="kpi-card kpi-gray p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">PnL Flotante</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_floating_pnl">$0.00</div>
                        </div>
                        <div class="kpi-card kpi-purple p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">Total</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_total_pnl">$0.00</div>
                        </div>
                        <div class="kpi-card p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">Win Rate</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_winrate" style="color: var(--accent-blue);">
                                0%</div>
                            <div class="text-[7px] text-slate-500" id="kpi_trades_info">0/0</div>
                        </div>
                        <div class="kpi-card kpi-green p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">Profit Factor</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_pf" style="color: var(--accent-green);">0.00
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Rendimiento por Caso (Elegante) -->
                    <div class="card p-3"
                        style="background: linear-gradient(145deg, rgba(22, 33, 62, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%); border: 1px solid rgba(168, 85, 247, 0.2);">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm">üìä</span>
                                <h3 class="font-bold text-xs" style="color: var(--accent-purple);">Rendimiento por Caso
                                </h3>
                            </div>
                            <button onclick="toggleCaseTable()" id="btnToggleCaseTable"
                                class="text-[10px] text-slate-400 hover:text-white px-2 py-1 rounded transition-all"
                                style="background: rgba(0,0,0,0.3);">Ocultar</button>
                        </div>
                        <div id="caseTableContainer" class="overflow-x-auto">
                            <table class="w-full" style="border-collapse: separate; border-spacing: 0 2px;">
                                <thead>
                                    <tr style="background: rgba(0, 0, 0, 0.3);">
                                        <th
                                            class="text-left py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Caso</th>
                                        <th
                                            class="text-center py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Cerr/Tot</th>
                                        <th
                                            class="text-center py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            WR</th>
                                        <th
                                            class="text-center py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            PF</th>
                                        <th
                                            class="text-right py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Real</th>
                                        <th
                                            class="text-right py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Flot</th>
                                        <th
                                            class="text-right py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Total</th>
                                    </tr>
                                </thead>
                                <tbody id="casePerformanceTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILA INFERIOR: Lista de Operaciones + Gr√°fico -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-4 mt-4">

                <!-- IZQUIERDA: Lista de Operaciones (5 columnas) -->
                <div class="xl:col-span-5 space-y-3">

                    <!-- Lista de Operaciones (NO ignorados) -->
                    <div class="card overflow-hidden p-0">
                        <!-- Header con t√≠tulo y FILTRAR (selecci√≥n m√∫ltiple + texto) -->
                        <div class="px-3 py-2 border-b border-slate-700/30 flex items-center justify-between gap-2"
                            style="background: linear-gradient(90deg, rgba(168, 85, 247, 0.1) 0%, transparent 100%);">
                            <div class="flex items-center gap-2">
                                <span class="text-sm">üìú</span>
                                <h3 class="font-bold text-slate-200 text-xs">Operaciones</h3>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-[9px] text-slate-400 font-semibold uppercase">Filtrar:</span>
                                <button onclick="toggleCaseFilter(0)" id="btnCaseAll"
                                    class="filter-btn active text-[9px] px-1.5 py-0.5">Todos</button>
                                <button onclick="toggleCaseFilter(1)" id="btnCase1"
                                    class="filter-btn btn-c1 text-[9px] px-1.5 py-0.5">C1</button>

                                <button onclick="toggleCaseFilter(2)" id="btnCase2"
                                    class="filter-btn btn-c2 text-[9px] px-1.5 py-0.5">C2</button>
                                <button onclick="toggleCaseFilter(3)" id="btnCase3"
                                    class="filter-btn btn-c3 text-[9px] px-1.5 py-0.5">C3</button>
                                <button onclick="toggleCaseFilter(4)" id="btnCase4"
                                    class="filter-btn btn-c4 text-[9px] px-1.5 py-0.5">C4</button>
                                <input type="text" id="filterText" placeholder="Buscar par..." oninput="runSimulation()"
                                    class="text-[9px] px-2 py-0.5 rounded border border-slate-600 bg-transparent text-slate-200 w-20 focus:outline-none focus:border-cyan-400 placeholder-slate-500">
                            </div>
                        </div>

                        <!-- ORDENAR -->
                        <div class="px-3 py-1 border-b border-slate-700/20 flex items-center gap-2"
                            style="background: rgba(0, 0, 0, 0.2);">
                            <span class="text-[9px] text-slate-400 font-semibold uppercase">Ordenar:</span>
                            <button onclick="setSortMode('none')" id="btnSortNone"
                                class="filter-btn active text-[9px] px-1.5 py-0.5">Defecto</button>
                            <button onclick="setSortMode('pnl_real_desc')" id="btnSortPnlRealDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">PnL ‚Üì</button>
                            <button onclick="setSortMode('pnl_real_asc')" id="btnSortPnlRealAsc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">PnL ‚Üë</button>
                            <button onclick="setSortMode('pnl_flot_desc')" id="btnSortPnlFlotDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">Flot ‚Üì</button>
                            <button onclick="setSortMode('pnl_flot_asc')" id="btnSortPnlFlotAsc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">Flot ‚Üë</button>
                            <button onclick="setSortMode('fib_desc')" id="btnSortFibDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5"
                                style="color: var(--accent-purple); border-color: rgba(168, 85, 247, 0.3);">Fib
                                ‚Üì</button>
                        </div>

                        <!-- IGNORAR -->
                        <div class="px-3 py-1 border-b border-slate-700/20 flex items-center justify-between gap-2"
                            style="background: rgba(0, 0, 0, 0.15);">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-[9px] text-slate-400 font-semibold uppercase">Ignorar:</span>
                                <label class="flex items-center gap-0.5 cursor-pointer">
                                    <input type="checkbox" id="ignoreC1" onchange="runSimulation()" class="w-2.5 h-2.5">
                                    <span class="text-[9px] font-medium" style="color: var(--accent-blue);">C1</span>
                                </label>

                                <label class="flex items-center gap-0.5 cursor-pointer">
                                    <input type="checkbox" id="ignoreC2" onchange="runSimulation()" class="w-2.5 h-2.5">
                                    <span class="text-[9px] font-medium" style="color: var(--accent-yellow);">C2</span>
                                </label>
                                <label class="flex items-center gap-0.5 cursor-pointer">
                                    <input type="checkbox" id="ignoreC3" onchange="runSimulation()" class="w-2.5 h-2.5">
                                    <span class="text-[9px] font-medium" style="color: var(--accent-orange);">C3</span>
                                </label>
                                <label class="flex items-center gap-0.5 cursor-pointer">
                                    <input type="checkbox" id="ignoreC4" onchange="runSimulation()" class="w-2.5 h-2.5">
                                    <span class="text-[9px] font-medium" style="color: var(--accent-red);">C4</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-slate-600">|</span>
                                <button onclick="ignoreAll()" class="text-[9px] text-slate-400 hover:text-white"
                                    title="Seleccionar todos">Todos</button>
                                <button onclick="unignoreAll()" class="text-[9px] text-slate-400 hover:text-white"
                                    title="Deseleccionar todos">Ninguno</button>
                            </div>
                        </div>

                        <!-- Tabla de operaciones -->
                        <div class="overflow-y-auto" style="max-height: 600px;">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th class="text-left text-[10px] py-1 px-2">Par</th>
                                        <th class="text-center text-[10px] py-1">Caso</th>
                                        <th class="text-center text-[10px] py-1">Estado</th>
                                        <th class="text-right text-[10px] py-1">Real</th>
                                        <th class="text-right text-[10px] py-1">Flot</th>
                                        <th class="text-center text-[10px] py-1">R:R</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="px-2 py-1 border-t border-slate-700/20" style="background: rgba(0, 0, 0, 0.2);">
                            <span class="text-[10px] text-slate-400" id="filter_stats_text">Total: 0 trades</span>
                        </div>
                    </div>

                    <!-- Lista de Ignorados (aparece solo si hay ignorados) -->
                    <div id="ignoredTradesSection" class="card overflow-hidden p-0 hidden" style="opacity: 0.7;">
                        <div class="px-3 py-2 border-b border-slate-700/30 flex items-center justify-between"
                            style="background: rgba(100, 100, 100, 0.2);">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px]">üö´</span>
                                <span class="text-[10px] text-slate-400 font-semibold">Ignorados</span>
                                <span id="ignoredCount" class="text-[9px] text-slate-500">(0)</span>
                            </div>
                            <button onclick="toggleIgnoredList()" id="btnToggleIgnored"
                                class="text-[9px] text-slate-400 hover:text-white">Mostrar</button>
                        </div>
                        <div id="ignoredTradesContainer" class="overflow-y-auto hidden" style="max-height: 150px;">
                            <table class="modern-table">
                                <tbody id="ignoredTradesBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- DERECHA: Panel del Gr√°fico (7 columnas) -->
                <div class="xl:col-span-7">
                    <!-- Panel del Gr√°fico -->
                    <div class="chart-panel" style="height: 100%;">
                        <div class="chart-header">
                            <div class="flex items-center gap-3">
                                <span class="chart-symbol" id="chartSymbol">Selecciona un trade</span>
                                <span id="chartCaseBadge" class="badge bg-neutral hidden">-</span>
                            </div>
                            <div class="chart-timeframe-btns">
                                <button class="tf-btn" data-tf="1" onclick="changeTimeframe('1')">1m</button>
                                <button class="tf-btn" data-tf="5" onclick="changeTimeframe('5')">5m</button>
                                <button class="tf-btn active" data-tf="15" onclick="changeTimeframe('15')">15m</button>
                                <button class="tf-btn" data-tf="60" onclick="changeTimeframe('60')">1H</button>
                                <button class="tf-btn" data-tf="240" onclick="changeTimeframe('240')">4H</button>
                            </div>
                        </div>
                        <div id="chartContainer" style="min-height: 550px;">
                            <div class="chart-placeholder">
                                <div class="chart-placeholder-icon">üìà</div>
                                <div>Haz clic en una operaci√≥n para ver el gr√°fico</div>
                            </div>
                        </div>
                        <div class="chart-info" id="chartInfo" style="display: none;">
                            <div class="chart-info-item">
                                <span class="chart-info-label">Entry:</span>
                                <span class="chart-info-value" id="infoEntry" style="color: #ff9800;">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">TP:</span>
                                <span class="chart-info-value" id="infoTP" style="color: var(--accent-green);">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">SL:</span>
                                <span class="chart-info-value" id="infoSL" style="color: var(--accent-red);">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">Fib 0%:</span>
                                <span class="chart-info-value" id="infoFibLow" style="color: #4caf50;">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">Fib 100%:</span>
                                <span class="chart-info-value" id="infoFibHigh" style="color: #f44336;">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawData = null;
        let processedTradesGlobal = [];
        let selectedTradeIndex = -1;
        let currentTimeframe = '15';

        // Chart variables
        let chart = null;
        let candleSeries = null;
        let chartLines = [];
        let candleDataGlobal = [];

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const hours = d.getHours().toString().padStart(2, '0');
            const mins = d.getMinutes().toString().padStart(2, '0');
            return `${day}/${month} ${hours}:${mins}`;
        }

        // ========== MODE SWITCH ==========
        function switchMode() {
            const isVisor = document.getElementById('modeSwitch').checked;
            if (isVisor) {
                window.location.href = 'index.html';
            }
        }

        // ========== SLIDER FUNCTIONS ==========
        function updateSliderValue(slider) {
            const valSpan = document.getElementById(slider.id + '_val');
            if (valSpan) {
                // Mostrar decimales para filtros de ganancia
                if (slider.id.includes('filter')) {
                    valSpan.textContent = parseFloat(slider.value).toFixed(1);
                } else {
                    valSpan.textContent = slider.value;
                }
            }
            // Actualizar l√≠neas del gr√°fico en tiempo real
            updateChartLinesFromSlider();
        }

        function updateChartLinesFromSlider() {
            // Solo actualizar si hay un trade seleccionado
            if (selectedTradeIndex < 0 || !processedTradesGlobal[selectedTradeIndex]) return;

            const item = processedTradesGlobal[selectedTradeIndex];
            const t = item.t;
            const cID = t.strategy_case;

            // Recalcular TP/SL con los nuevos valores de los sliders
            const settings = getCaseSettings(cID);
            const fibRange = (t.fib_high || 0) - (t.fib_low || 0);
            const newTpPrice = (t.fib_low || 0) + fibRange * settings.tp;
            const newSlPrice = settings.sl > 0 ? (t.fib_low || 0) + fibRange * settings.sl : Infinity;

            // Actualizar info panel
            document.getElementById('infoTP').textContent = '$' + newTpPrice.toFixed(4);
            document.getElementById('infoSL').textContent = newSlPrice === Infinity ? '‚àû' : '$' + newSlPrice.toFixed(4);

            // Actualizar item temporal para redibujar
            const updatedItem = { ...item, tpPrice: newTpPrice, slPrice: newSlPrice };
            drawTradeLines(updatedItem);
        }

        function adjustSlider(sliderId, delta) {
            const slider = document.getElementById(sliderId);
            if (!slider) return;
            const step = parseFloat(slider.step) || 1;
            const min = parseFloat(slider.min) || 0;
            const max = parseFloat(slider.max) || 100;
            let newValue = parseFloat(slider.value) + (delta * step);
            newValue = Math.max(min, Math.min(max, newValue));
            slider.value = newValue;
            updateSliderValue(slider);
            runSimulation();
        }

        function resetSlider(sliderId, defaultVal) {
            const slider = document.getElementById(sliderId);
            if (!slider) return;

            // Intentar obtener valor desde sharedConfig si existe
            let finalVal = defaultVal;
            if (sharedConfig && sharedConfig.strategies) {
                // Mapear sliderId a config key
                // IDs son tp_c1, sl_c1, tp_c1pp, sl_c1pp, etc.
                const parts = sliderId.split('_'); // ['tp', 'c1']
                if (parts.length === 2) {
                    const type = parts[0]; // tp or sl
                    const caseName = parts[1]; // c1, c1pp, c2, etc

                    if (sharedConfig.strategies[caseName] && sharedConfig.strategies[caseName][type]) {
                        // Config guarda decimales (0.51), slider usa enteros (51)
                        finalVal = Math.round(sharedConfig.strategies[caseName][type] * 100);
                    }
                }
            }

            slider.value = finalVal;
            updateSliderValue(slider);
            runSimulation();
        }

        // ========== DOWNLOAD FROM MV ==========
        async function downloadFromMV() {
            const btn = document.querySelector('.download-mv-btn');
            const originalText = btn.innerHTML;

            btn.classList.add('loading');
            btn.innerHTML = '<span>‚è≥</span> Descargando...';

            try {
                // Descargar trades.json desde el mismo servidor web
                // El web_server.py sirve los archivos del directorio
                const response = await fetch('trades.json?nocache=' + Date.now());

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Procesar los datos
                rawData = data;
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('refreshBtn').classList.remove('hidden');
                runSimulation();

                btn.innerHTML = '<span>‚úÖ</span> Cargado!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('loading');
                }, 2000);

            } catch (error) {
                console.error('Error descargando trades.json:', error);
                btn.classList.remove('loading');
                btn.innerHTML = '<span>‚ùå</span> Error';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);

                // Mostrar mensaje de error
                alert(`No se pudo cargar trades.json.\n\nAseg√∫rate de:\n1. Que el archivo trades.json exista\n2. Que est√©s accediendo desde el servidor web (no abriendo el HTML directamente)\n\nError: ${error.message}`);
            }
        }

        function toggleSL(caseNum) {
            const suffix = `c${caseNum}`;
            const checkbox = document.getElementById(`sl_enabled_${suffix}`);
            const slider = document.getElementById(`sl_${suffix}`);
            const valSpan = document.getElementById(`sl_${suffix}_val`);
            const container = document.getElementById(`sl_container_${suffix}`);

            if (!checkbox || !slider) return;

            if (checkbox.checked) {
                slider.disabled = false;
                slider.classList.remove('sl-disabled');
                if (container) container.querySelectorAll('label, span').forEach(el => el.classList.remove('sl-disabled'));
                valSpan.textContent = slider.value;
            } else {
                slider.disabled = true;
                slider.classList.add('sl-disabled');
                if (container) container.querySelectorAll('label, span').forEach(el => el.classList.add('sl-disabled'));
                valSpan.textContent = 'OFF';
            }

            // Actualizar l√≠neas del gr√°fico
            updateChartLinesFromSlider();
        }

        // ========== FILTER/SORT ==========
        let casePriority = 0;
        let sortMode = 'none';
        let caseFilters = new Set(); // Para selecci√≥n m√∫ltiple de casos

        function toggleCaseFilter(caseNum) {
            if (caseNum === 0) {
                // "Todos" - limpiar todos los filtros
                caseFilters.clear();
                document.querySelectorAll('#btnCase1, #btnCase2, #btnCase3, #btnCase4').forEach(btn => btn.classList.remove('active'));
                document.getElementById('btnCaseAll')?.classList.add('active');
            } else {
                // Toggle individual case
                document.getElementById('btnCaseAll')?.classList.remove('active');
                const btnId = `btnCase${caseNum}`;
                const btn = document.getElementById(btnId);

                if (caseFilters.has(caseNum)) {
                    caseFilters.delete(caseNum);
                    btn?.classList.remove('active');
                } else {
                    caseFilters.add(caseNum);
                    btn?.classList.add('active');
                }

                // Si no hay ning√∫n filtro seleccionado, activar "Todos"
                if (caseFilters.size === 0) {
                    document.getElementById('btnCaseAll')?.classList.add('active');
                }
            }
            runSimulation();
        }

        function setCasePriority(caseNum) {
            casePriority = caseNum;
            document.querySelectorAll('#btnCaseAll, #btnCase1, #btnCase11, #btnCase2, #btnCase3, #btnCase4').forEach(btn => btn.classList.remove('active'));
            const btnId = caseNum === 0 ? 'btnCaseAll' : `btnCase${caseNum}`;
            document.getElementById(btnId)?.classList.add('active');
            runSimulation();
        }

        function setSortMode(mode) {
            sortMode = mode;
            document.querySelectorAll('[id^="btnSort"]').forEach(btn => btn.classList.remove('active'));
            const btnMap = {
                'none': 'btnSortNone',
                'pnl_real_desc': 'btnSortPnlRealDesc',
                'pnl_real_asc': 'btnSortPnlRealAsc',
                'pnl_flot_desc': 'btnSortPnlFlotDesc',
                'pnl_flot_asc': 'btnSortPnlFlotAsc',
                'fib_desc': 'btnSortFibDesc'
            };
            document.getElementById(btnMap[mode])?.classList.add('active');
            runSimulation();
        }

        function ignoreAll() {
            ['C1', 'C2', 'C3', 'C4'].forEach(c => {
                const cb = document.getElementById(`ignore${c}`);
                if (cb) cb.checked = true;
            });
            runSimulation();
        }

        function unignoreAll() {
            ['C1', 'C11', 'C2', 'C3', 'C4'].forEach(c => {
                const cb = document.getElementById(`ignore${c}`);
                if (cb) cb.checked = false;
            });
            runSimulation();
        }

        async function resetDefaults() {
            // Recargar config desde disco si es posible
            await loadSharedConfig();

            // Reset SL toggles
            [1, 2, 3, 4].forEach(c => {
                const cb = document.getElementById(`sl_enabled_c${c}`);
                if (cb) { cb.checked = true; toggleSL(c); }
            });

            // Valores por defecto (se sobreescriben con shared_config si est√° disponible)
            let defaults = {
                'tp_c1': 51, 'sl_c1': 67,
                'tp_c2': 50, 'sl_c2': 82,
                'tp_c3': 50, 'sl_c3': 105,
                'tp_c4': 50, 'sl_c4': 105,
                'filter_min_profit': 0, 'filter_max_profit': 0
            };

            // Si hay configuraci√≥n compartida, usarla
            if (sharedConfig && sharedConfig.strategies) {
                const s = sharedConfig.strategies;
                if (s.c1) { defaults['tp_c1'] = Math.round(s.c1.tp * 100); defaults['sl_c1'] = Math.round(s.c1.sl * 100); }
                if (s.c2) { defaults['tp_c2'] = Math.round(s.c2.tp * 100); defaults['sl_c2'] = Math.round(s.c2.sl * 100); }
                if (s.c3) { defaults['tp_c3'] = Math.round(s.c3.tp * 100); defaults['sl_c3'] = Math.round(s.c3.sl * 100); }
                if (s.c4) { defaults['tp_c4'] = Math.round(s.c4.tp * 100); defaults['sl_c4'] = Math.round(s.c4.sl * 100); }
            }

            Object.entries(defaults).forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (el) { el.value = val; updateSliderValue(el); }
            });

            // Unignore all
            unignoreAll();
            setCasePriority(0);
            setSortMode('none');
            runSimulation();
        }

        // ========== DATA LOADING ==========
        let sharedConfig = null;

        async function loadSharedConfig() {
            try {
                const response = await fetch('/shared_config.json?nocache=' + Date.now(), { cache: 'no-store' });
                if (response.ok) {
                    sharedConfig = await response.json();
                    console.log('‚úÖ Configuraci√≥n compartida cargada');
                    // Aplicar configuraci√≥n autom√°ticamente al inicio
                    applySharedConfig();
                }
            } catch (e) {
                console.log('‚ö†Ô∏è No se pudo cargar shared_config.json, usando valores por defecto');
            }
        }

        function applySharedConfig() {
            if (!sharedConfig || !sharedConfig.strategies) return;

            const strategies = sharedConfig.strategies;
            const mapping = {
                'c1': { tp: 'tp_c1', sl: 'sl_c1' },
                'c2': { tp: 'tp_c2', sl: 'sl_c2' },
                'c3': { tp: 'tp_c3', sl: 'sl_c3' },
                'c4': { tp: 'tp_c4', sl: 'sl_c4' }
            };

            for (const [key, ids] of Object.entries(mapping)) {
                const config = strategies[key];
                if (config) {
                    // TP (convertir de decimal a porcentaje)
                    const tpEl = document.getElementById(ids.tp);
                    if (tpEl && config.tp) {
                        tpEl.value = Math.round(config.tp * 100);
                        updateSliderValue(tpEl);
                    }
                    // SL (convertir de decimal a porcentaje)
                    const slEl = document.getElementById(ids.sl);
                    if (slEl && config.sl) {
                        slEl.value = Math.round(config.sl * 100);
                        updateSliderValue(slEl);
                    }
                }
            }
        }

        async function autoLoadTradesJson() {
            const filesToTry = ['/2trades.json', '/trades.json'];
            for (const fileName of filesToTry) {
                try {
                    const response = await fetch(fileName + '?nocache=' + Date.now(), { cache: 'no-store' });
                    if (response.ok) {
                        rawData = await response.json();
                        document.getElementById('dashboard').classList.remove('hidden');
                        document.getElementById('refreshBtn').classList.remove('hidden');
                        runSimulation();
                        console.log('‚úÖ Cargado:', fileName);
                        return;
                    }
                } catch (e) { }
            }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '‚è≥...';
            btn.disabled = true;
            await autoLoadTradesJson();
            btn.innerHTML = 'üîÑ Actualizar';
            btn.disabled = false;
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    rawData = JSON.parse(e.target.result);
                    document.getElementById('dashboard').classList.remove('hidden');
                    runSimulation();
                } catch (err) { alert("Error al leer JSON"); }
            };
            reader.readAsText(file);
        });

        // ========== CASE SETTINGS ==========
        function getCaseSettings(caseId) {
            let c = [1, 2, 3, 4].includes(caseId) ? caseId : 1;
            const limits = {
                1: { tpMax: 0.61, slMin: 0.62 },
                2: { tpMax: 0.61, slMin: 0.65 },
                3: { tpMax: 0.78, slMin: 0.79 },
                4: { tpMax: 0.90, slMin: 0.90 }
            };
            const limit = limits[c];

            let tp = (parseFloat(document.getElementById(`tp_c${c}`)?.value) || 50) / 100;
            const slEnabled = document.getElementById(`sl_enabled_c${c}`)?.checked ?? true;
            let sl = slEnabled ? (parseFloat(document.getElementById(`sl_c${c}`)?.value) || 100) / 100 : 0;

            if (tp > limit.tpMax) tp = limit.tpMax;
            if (sl > 0 && sl < limit.slMin) sl = limit.slMin;

            return { tp, sl };
        }

        // ========== SIMULATION ==========
        function runSimulation() {
            if (!rawData) return;

            const ignoredCases = {
                1: document.getElementById('ignoreC1')?.checked || false,
                2: document.getElementById('ignoreC2')?.checked || false,
                3: document.getElementById('ignoreC3')?.checked || false,
                4: document.getElementById('ignoreC4')?.checked || false
            };

            let stats = {
                realized: 0, floating: 0,
                wins: 0, losses: 0, closedTrades: 0, openTrades: 0,
                grossWin: 0, grossLoss: 0, totalTrades: 0
            };

            // Filtro de texto (b√∫squeda) - AHORA SOLO VISUAL
            const searchInput = document.getElementById('searchInput');
            const searchQuery = searchInput ? searchInput.value.toUpperCase() : '';

            // Configuraci√≥n general
            const minProfit = parseFloat(document.getElementById('filter_min_profit')?.value) || 0;
            const maxProfit = parseFloat(document.getElementById('filter_max_profit')?.value) || 0;

            // Settings actuales para C1 (para la nueva regla)
            const c1Settings = getCaseSettings(1);

            let caseStats = {};
            [1, 2, 3, 4].forEach(i => {
                caseStats[i] = { total: 0, realizedPnl: 0, floatingPnl: 0, wins: 0, losses: 0, grossWin: 0, grossLoss: 0 };
            });

            // Unify trades
            let allTrades = [];
            if (rawData.history) rawData.history.forEach(t => {
                t._src = 'HIST';
                // Combinar pre y post close para an√°lisis completo de "qu√© hubiera pasado"
                const preMax = t.max_price_pre_close || t.entry_price;
                const postMax = t.max_price_post_close || preMax;
                const preMin = t.min_price_pre_close || t.entry_price;
                const postMin = t.min_price_post_close || preMin;
                t._max = Math.max(preMax, postMax);
                t._min = Math.min(preMin, postMin, t.close_price || t.entry_price);
                allTrades.push(t);
            });
            if (rawData.open_positions) Object.values(rawData.open_positions).forEach(t => {
                t._src = 'OPEN';
                const effectivePrice = (t.current_price && t.current_price > 0) ? t.current_price : t.entry_price;
                t._max = Math.max(t.max_price_pre_close || t.entry_price, effectivePrice);
                t._min = Math.min(t.min_price_pre_close || t.entry_price, effectivePrice);
                if (!t.fib_high) t.fib_high = t.entry_price * 1.05;
                if (!t.fib_low) t.fib_low = t.entry_price * 0.95;
                allTrades.push(t);
            });

            // Process trades
            let processedTrades = [];

            allTrades.forEach(t => {
                stats.totalTrades++;
                let cID = t.strategy_case || 1;

                // Determinar si est√° ignorado por checkbox
                let isIgnored = ignoredCases[cID] || false;

                const s = getCaseSettings(cID);
                const range = t.fib_high - t.fib_low;
                const tpPrice = t.fib_low + (range * s.tp);
                let slPrice = s.sl > 0 ? t.fib_low + (range * s.sl) : Infinity;

                // CALCULAR NIVEL FIB DE ENTRADA
                let fibEntryLevel = 0;
                if (t.fib_level) {
                    fibEntryLevel = parseFloat(t.fib_level);
                } else if (t.fib_high && t.fib_low && t.entry_price) {
                    if (range > 0) {
                        fibEntryLevel = (t.entry_price - t.fib_low) / range;
                    }
                }

                // REGLA GENERAL (Todos los casos): Si Fib Entry >= SL Slider, ignorar
                // Esto filtra trades que entraron en una zona peor que el SL configurado
                if (s.sl > 0) {
                    if (fibEntryLevel >= s.sl) {
                        isIgnored = true;
                    }
                }

                let status = "", rPnl = 0, fPnl = 0, css = "";
                let isClosed = false;

                const slIsValid = slPrice > t.entry_price;
                const hitSL = (s.sl > 0) && slIsValid && (t._max >= slPrice);

                const originalReason = (t.reason || '').toUpperCase();
                const originalTpPrice = t.take_profit || t.entry_price; // TP original del trade

                // Para determinar si toc√≥ TP, decidimos qu√© precio m√≠nimo usar:
                // - Siempre usamos t._min (pre + post) que representa el rango completo
                // - EXCEPTO: si el trade cerr√≥ por TP original Y el nuevo TP es M√ÅS ALTO que el original
                //   (en ese caso el trade ya cerr√≥ antes de poder alcanzar un TP m√°s bajo)
                let effectiveMinForTP = t._min;
                if (t._src === 'HIST' && originalReason === 'TP' && tpPrice >= originalTpPrice) {
                    // El nuevo TP es igual o m√°s alto que el original
                    // El trade ya cerr√≥ en el TP original, solo considerar precio pre-close
                    effectiveMinForTP = t.min_price_pre_close || t.entry_price;
                }
                // Si el nuevo TP es m√°s bajo que el original, el trade habr√≠a seguido corriendo
                // => usamos t._min que incluye pre + post

                const hitTP = effectiveMinForTP <= tpPrice;
                const potProfit = (t.entry_price - tpPrice) * t.quantity;

                if (hitSL) {
                    status = "SL ‚ùå"; rPnl = (t.entry_price - slPrice) * t.quantity; isClosed = true; css = "bg-loss";
                } else if (hitTP) {
                    // Usar siempre el profit simulado basado en el TP configurado
                    status = "TP ‚úÖ"; rPnl = potProfit; isClosed = true; css = "bg-win";
                } else {
                    if (t._src === 'HIST') {
                        if (originalReason === 'TP' && !hitTP) {
                            // El TP real fue diferente al configurado, seguir√≠a corriendo
                            status = "RUN ‚è≥"; fPnl = (t.entry_price - (t.close_price || t.entry_price)) * t.quantity; css = "bg-run";
                        } else if (originalReason === 'SL' && !hitSL) {
                            status = "RUN ‚è≥"; fPnl = (t.entry_price - (t.close_price || t.entry_price)) * t.quantity; css = "bg-run";
                        } else {
                            status = "CLOSED"; rPnl = t.pnl; css = t.pnl >= 0 ? "bg-win" : "bg-loss"; isClosed = true;
                        }
                    } else {
                        status = "RUN ‚è≥"; fPnl = (t.entry_price - t.current_price) * t.quantity; css = "bg-run";
                    }
                }

                // NO calcular stats aqu√≠ - se har√° despu√©s de los filtros

                processedTrades.push({ t, cID, s, tpPrice, slPrice, status, css, rPnl, fPnl, isIgnored, isClosed, fibEntryLevel });
            });

            // Filter by case (selecci√≥n m√∫ltiple)
            let displayTrades = processedTrades;
            if (caseFilters.size > 0) {
                displayTrades = processedTrades.filter(p => caseFilters.has(p.cID));
            }

            // Filter by text (buscar par)
            const filterText = (document.getElementById('filterText')?.value || '').toUpperCase().trim();
            if (filterText) {
                displayTrades = displayTrades.filter(p => p.t.symbol.toUpperCase().includes(filterText));
            }

            // Apply profit filters - marcar trades filtrados por ganancia
            // Nota: minProfit y maxProfit ya se leyeron al inicio
            // const minProfit = parseFloat(document.getElementById('filter_min_profit')?.value) || 0;
            // const maxProfit = parseFloat(document.getElementById('filter_max_profit')?.value) || 0;

            // Marcar trades filtrados por ganancia (para excluirlos de stats)
            displayTrades.forEach(p => {
                p.filteredByProfit = false;
                const pnl = p.rPnl !== 0 ? p.rPnl : p.fPnl;
                if (minProfit > 0 && pnl > 0 && pnl < minProfit) {
                    p.filteredByProfit = true;
                }
                if (maxProfit > 0 && pnl > 0 && pnl > maxProfit) {
                    p.filteredByProfit = true;
                }
            });

            // Ahora calcular stats DESPU√âS de todos los filtros
            // Solo incluir trades que NO est√°n ignorados NI filtrados por ganancia
            displayTrades.forEach(p => {
                const { cID, rPnl, fPnl, isIgnored, isClosed, filteredByProfit } = p;

                stats.totalTrades++;

                if (!isIgnored && !filteredByProfit) {
                    caseStats[cID].total++;
                    if (isClosed) {
                        stats.closedTrades++; stats.realized += rPnl;
                        caseStats[cID].realizedPnl += rPnl;
                        if (rPnl > 0) {
                            stats.wins++; stats.grossWin += rPnl;
                            caseStats[cID].wins++;
                            caseStats[cID].grossWin += rPnl;
                        }
                        else {
                            stats.losses++; stats.grossLoss += Math.abs(rPnl);
                            caseStats[cID].losses++;
                            caseStats[cID].grossLoss += Math.abs(rPnl);
                        }
                    } else {
                        stats.openTrades++; stats.floating += fPnl;
                        caseStats[cID].floatingPnl += fPnl;
                    }
                }
            });

            // Filtrar para visualizaci√≥n (excluir trades filtrados por ganancia)
            displayTrades = displayTrades.filter(p => !p.filteredByProfit);

            // Sort
            if (sortMode === 'pnl_real_desc') {
                displayTrades.sort((a, b) => b.rPnl - a.rPnl);
            } else if (sortMode === 'pnl_real_asc') {
                displayTrades.sort((a, b) => a.rPnl - b.rPnl);
            } else if (sortMode === 'pnl_flot_desc') {
                displayTrades.sort((a, b) => b.fPnl - a.fPnl);
            } else if (sortMode === 'pnl_flot_asc') {
                displayTrades.sort((a, b) => a.fPnl - b.fPnl);
            } else if (sortMode === 'fib_desc') {
                displayTrades.sort((a, b) => (b.fibEntryLevel || 0) - (a.fibEntryLevel || 0));
            }

            processedTradesGlobal = displayTrades;

            // Separar trades ignorados de no ignorados
            // APLICAR FILTRO DE B√öSQUEDA AQU√ç (SOLO VISUAL)
            const activeTrades = displayTrades.filter(p => !p.isIgnored && (!searchQuery || p.t.symbol.includes(searchQuery)));
            const ignoredTrades = displayTrades.filter(p => p.isIgnored && (!searchQuery || p.t.symbol.includes(searchQuery)));

            // Render tabla principal (solo NO ignorados)
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';

            activeTrades.forEach((item) => {
                // Obtener √≠ndice real en processedTradesGlobal
                const idx = processedTradesGlobal.indexOf(item);
                const { t, cID, status, css, rPnl, fPnl, tpPrice, slPrice } = item;
                const caseDisplay = `C${cID}`;
                const rowClass = `row-c${cID}`;
                const selectedClass = idx === selectedTradeIndex ? 'selected' : '';

                // Colors for PnL columns
                const rPnlColor = rPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                const fPnlColor = fPnl >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)';

                // R:R calculation
                let rrDisplay = '-';
                let rrColor = 'var(--text-muted)';
                if (slPrice !== Infinity && slPrice > t.entry_price) {
                    const reward = t.entry_price - tpPrice;
                    const risk = slPrice - t.entry_price;
                    if (risk > 0) {
                        const rr = reward / risk;
                        rrDisplay = '1:' + rr.toFixed(1);
                        rrColor = rr >= 1 ? 'var(--accent-green)' : (rr >= 0.5 ? 'var(--accent-yellow)' : 'var(--accent-red)');
                    }
                }

                tbody.innerHTML += `
                    <tr class="${rowClass} ${selectedClass}" onclick="selectTrade(${idx})" data-idx="${idx}">
                        <td class="py-1 px-2">
                            <div class="font-bold text-xs">${t.symbol}</div>
                            <div class="text-[9px] text-slate-400 font-normal leading-tight">
                                ${(() => {
                        // Fecha
                        let dateStr = t.entry_time;
                        if (!dateStr && t.executions && t.executions.length > 0) {
                            dateStr = t.executions[0].time;
                        }
                        const dateDisplay = formatDateShort(dateStr);

                        // Fib Entry Calc
                        let fibDisplay = '-';
                        if (t.fib_level) {
                            fibDisplay = (parseFloat(t.fib_level) * 100).toFixed(1);
                        } else if (t.fib_high && t.fib_low && t.entry_price) {
                            const range = t.fib_high - t.fib_low;
                            if (range > 0) {
                                const fibVal = (t.entry_price - t.fib_low) / range;
                                fibDisplay = (fibVal * 100).toFixed(1);
                            }
                        }

                        return `${dateDisplay} <span style="color: var(--text-muted)">|</span> Fib: ${fibDisplay}`;
                    })()}
                            </div>
                        </td>
                        <td class="text-center py-1"><span class="badge text-[9px]" style="padding: 2px 6px;">${caseDisplay}</span></td>
                        <td class="text-center py-1"><span class="badge ${css} text-[9px]" style="padding: 2px 6px;">${status}</span></td>
                        <td class="text-right font-mono font-bold text-xs py-1" style="color: ${rPnlColor}">${rPnl !== 0 ? '$' + rPnl.toFixed(2) : '-'}</td>
                        <td class="text-right font-mono text-xs py-1" style="color: ${fPnlColor}">${fPnl !== 0 ? '$' + fPnl.toFixed(2) : '-'}</td>
                        <td class="text-center font-mono text-xs py-1" style="color: ${rrColor}">${rrDisplay}</td>
                    </tr>
                `;
            });

            // Render lista de ignorados
            const ignoredSection = document.getElementById('ignoredTradesSection');
            const ignoredBody = document.getElementById('ignoredTradesBody');
            const ignoredCount = document.getElementById('ignoredCount');

            if (ignoredTrades.length > 0) {
                ignoredSection.classList.remove('hidden');
                ignoredCount.textContent = `(${ignoredTrades.length})`;
                ignoredBody.innerHTML = '';

                ignoredTrades.forEach((item) => {
                    const { t, cID, status, css, rPnl, fPnl } = item;
                    const caseDisplay = cID == 11 ? 'C1++' : `C${cID}`;
                    const rowClass = cID == 11 ? 'row-c11' : `row-c${cID}`;
                    const rPnlColor = rPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    const fPnlColor = fPnl >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)';

                    ignoredBody.innerHTML += `
                        <tr class="${rowClass}" style="opacity: 0.5;">
                            <td class="font-bold text-xs py-1 px-2">${t.symbol}</td>
                            <td class="text-center py-1"><span class="badge text-[9px]" style="padding: 2px 6px;">${caseDisplay}</span></td>
                            <td class="text-center py-1"><span class="badge ${css} text-[9px]" style="padding: 2px 6px;">${status}</span></td>
                            <td class="text-right font-mono text-xs py-1" style="color: ${rPnlColor}">${rPnl !== 0 ? '$' + rPnl.toFixed(2) : '-'}</td>
                            <td class="text-right font-mono text-xs py-1" style="color: ${fPnlColor}">${fPnl !== 0 ? '$' + fPnl.toFixed(2) : '-'}</td>
                        </tr>
                    `;
                });
            } else {
                ignoredSection.classList.add('hidden');
            }

            // Update KPIs
            const gWR = stats.closedTrades > 0 ? ((stats.wins / stats.closedTrades) * 100).toFixed(1) + '%' : '0%';
            const gPF = stats.grossLoss > 0 ? (stats.grossWin / stats.grossLoss).toFixed(2) : (stats.grossWin > 0 ? '‚àû' : '0.00');
            const gTotal = stats.realized + stats.floating;

            document.getElementById('kpi_realized_pnl').innerText = `$${stats.realized.toFixed(2)}`;
            document.getElementById('kpi_realized_pnl').className = `kpi-value text-base mt-0.5 ${stats.realized >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('kpi_floating_pnl').innerText = `$${stats.floating.toFixed(2)}`;
            document.getElementById('kpi_floating_pnl').style.color = stats.floating >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)';
            document.getElementById('kpi_total_pnl').innerText = `$${gTotal.toFixed(2)}`;
            document.getElementById('kpi_total_pnl').className = `kpi-value text-base mt-0.5 ${gTotal >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('kpi_winrate').innerText = gWR;
            document.getElementById('kpi_trades_info').innerText = `${stats.closedTrades}/${stats.totalTrades}`;
            document.getElementById('kpi_pf').innerText = gPF;

            // Update Case Performance Table
            updateCasePerformanceTable(caseStats);

            document.getElementById('filter_stats_text').innerText = `Total: ${activeTrades.length} trades`;
        }

        function updateCasePerformanceTable(caseStats) {
            const tbody = document.getElementById('casePerformanceTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            const caseColors = { 1: 'var(--accent-blue)', 2: 'var(--accent-yellow)', 3: 'var(--accent-orange)', 4: 'var(--accent-red)' };
            const caseNames = { 1: 'Caso 1', 2: 'Caso 2', 3: 'Caso 3', 4: 'Caso 4' };

            let totalStats = { total: 0, closed: 0, wins: 0, grossWin: 0, grossLoss: 0, realized: 0, floating: 0 };

            [1, 2, 3, 4].forEach(i => {
                const s = caseStats[i];
                if (s.total === 0) return;

                const closed = s.wins + s.losses;
                const winRate = closed > 0 ? ((s.wins / closed) * 100).toFixed(1) : '-';
                const pf = s.grossLoss > 0 ? (s.grossWin / s.grossLoss).toFixed(2) : (s.grossWin > 0 ? '‚àû' : '-');
                const total = s.realizedPnl + s.floatingPnl;

                // Acumular totales
                totalStats.total += s.total;
                totalStats.closed += closed;
                totalStats.wins += s.wins;
                totalStats.grossWin += s.grossWin;
                totalStats.grossLoss += s.grossLoss;
                totalStats.realized += s.realizedPnl;
                totalStats.floating += s.floatingPnl;

                tbody.innerHTML += `
                    <tr style="background: rgba(0, 0, 0, 0.15); transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.3)'" onmouseout="this.style.background='rgba(0,0,0,0.15)'">
                        <td class="py-2 px-3 font-bold text-sm" style="color: ${caseColors[i]}; border-left: 3px solid ${caseColors[i]};">${caseNames[i]}</td>
                        <td class="py-2 px-3 text-center text-sm text-slate-300">${closed} / ${s.total}</td>
                        <td class="py-2 px-3 text-center text-sm font-semibold" style="color: ${parseFloat(winRate) >= 50 ? 'var(--accent-green)' : (winRate === '-' ? 'var(--text-muted)' : 'var(--accent-red)')}">${winRate}${winRate !== '-' ? '%' : ''}</td>
                        <td class="py-2 px-3 text-center text-sm font-mono" style="color: ${parseFloat(pf) >= 1 ? 'var(--accent-green)' : (pf === '-' || pf === '‚àû' ? 'var(--text-muted)' : 'var(--accent-red)')}">${pf}</td>
                        <td class="py-2 px-3 text-right text-sm font-mono font-semibold" style="color: ${s.realizedPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${s.realizedPnl.toFixed(2)}</td>
                        <td class="py-2 px-3 text-right text-sm font-mono" style="color: ${s.floatingPnl >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)'}">$${s.floatingPnl.toFixed(2)}</td>
                        <td class="py-2 px-3 text-right text-sm font-mono font-bold" style="color: ${total >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${total.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Fila de TOTAL
            const totalWinRate = totalStats.closed > 0 ? ((totalStats.wins / totalStats.closed) * 100).toFixed(1) : '-';
            const totalPF = totalStats.grossLoss > 0 ? (totalStats.grossWin / totalStats.grossLoss).toFixed(2) : (totalStats.grossWin > 0 ? '‚àû' : '-');
            const totalPnl = totalStats.realized + totalStats.floating;

            tbody.innerHTML += `
                <tr style="background: linear-gradient(90deg, rgba(168, 85, 247, 0.15) 0%, rgba(0, 212, 255, 0.1) 100%); border-top: 2px solid rgba(168, 85, 247, 0.3);">
                    <td class="py-2 px-3 font-bold text-sm" style="color: var(--accent-purple); border-left: 3px solid var(--accent-purple);">üìä TOTAL</td>
                    <td class="py-2 px-3 text-center text-sm font-bold text-white">${totalStats.closed} / ${totalStats.total}</td>
                    <td class="py-2 px-3 text-center text-sm font-bold" style="color: ${parseFloat(totalWinRate) >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'}">${totalWinRate}%</td>
                    <td class="py-2 px-3 text-center text-sm font-mono font-bold" style="color: ${parseFloat(totalPF) >= 1 ? 'var(--accent-green)' : 'var(--accent-red)'}">${totalPF}</td>
                    <td class="py-2 px-3 text-right text-sm font-mono font-bold" style="color: ${totalStats.realized >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${totalStats.realized.toFixed(2)}</td>
                    <td class="py-2 px-3 text-right text-sm font-mono font-bold" style="color: ${totalStats.floating >= 0 ? 'var(--accent-blue)' : 'var(--accent-orange)'}">$${totalStats.floating.toFixed(2)}</td>
                    <td class="py-2 px-3 text-right text-sm font-mono font-bold" style="color: ${totalPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${totalPnl.toFixed(2)}</td>
                </tr>
            `;
        }

        function toggleCaseTable() {
            const container = document.getElementById('caseTableContainer');
            const btn = document.getElementById('btnToggleCaseTable');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.textContent = 'Ocultar';
            } else {
                container.style.display = 'none';
                btn.textContent = 'Mostrar';
            }
        }

        function toggleIgnoredList() {
            const container = document.getElementById('ignoredTradesContainer');
            const btn = document.getElementById('btnToggleIgnored');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.textContent = 'Ocultar';
            } else {
                container.classList.add('hidden');
                btn.textContent = 'Mostrar';
            }
        }

        // ========== CHART ==========
        function selectTrade(idx) {
            selectedTradeIndex = idx;

            // Update selection visual
            document.querySelectorAll('#tradesTableBody tr').forEach(tr => tr.classList.remove('selected'));
            document.querySelector(`#tradesTableBody tr[data-idx="${idx}"]`)?.classList.add('selected');

            const item = processedTradesGlobal[idx];
            if (item) {
                showTradeOnChart(item);
            }
        }

        async function showTradeOnChart(item) {
            const t = item.t;

            // Update header
            document.getElementById('chartSymbol').textContent = t.symbol;
            const caseBadge = document.getElementById('chartCaseBadge');
            caseBadge.textContent = item.cID == 11 ? 'C1++' : `C${item.cID}`;
            caseBadge.classList.remove('hidden');

            // Show info panel
            document.getElementById('chartInfo').style.display = 'flex';
            document.getElementById('infoEntry').textContent = '$' + t.entry_price.toFixed(4);
            document.getElementById('infoTP').textContent = '$' + item.tpPrice.toFixed(4);
            document.getElementById('infoSL').textContent = item.slPrice === Infinity ? '‚àû' : '$' + item.slPrice.toFixed(4);
            document.getElementById('infoFibLow').textContent = '$' + (t.fib_low || 0).toFixed(4);
            document.getElementById('infoFibHigh').textContent = '$' + (t.fib_high || 0).toFixed(4);

            // Initialize chart if needed
            if (!chart) {
                initChart();
            }

            // Load candle data
            await loadCandleData(t.symbol);

            // Draw lines
            drawTradeLines(item);
        }

        function initChart() {
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';

            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: Math.max(500, container.clientHeight - 10),
                layout: {
                    background: { type: 'solid', color: 'transparent' },
                    textColor: '#94a3b8'
                },
                grid: {
                    vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    horzLines: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: 'rgba(255, 255, 255, 0.1)' },
                timeScale: { borderColor: 'rgba(255, 255, 255, 0.1)', timeVisible: true }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#22c55e',
                downColor: '#ef4444',
                borderUpColor: '#22c55e',
                borderDownColor: '#ef4444',
                wickUpColor: '#22c55e',
                wickDownColor: '#ef4444',
                priceFormat: {
                    type: 'price',
                    precision: 6,
                    minMove: 0.000001
                }
            });

            // Resize handler
            window.addEventListener('resize', () => {
                if (chart) chart.applyOptions({ width: container.clientWidth });
            });
        }

        async function loadCandleData(symbol) {
            try {
                const url = `https://api.bybit.com/v5/market/kline?category=linear&symbol=${symbol}&interval=${currentTimeframe}&limit=200`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.retCode === 0 && data.result?.list) {
                    const candles = data.result.list.reverse().map(c => ({
                        time: parseInt(c[0]) / 1000,
                        open: parseFloat(c[1]),
                        high: parseFloat(c[2]),
                        low: parseFloat(c[3]),
                        close: parseFloat(c[4])
                    }));

                    candleDataGlobal = candles; // Save for markers
                    candleSeries.setData(candles);
                    chart.timeScale().fitContent();
                }
            } catch (error) {
                console.error('Error loading candles:', error);
            }
        }

        function drawTradeLines(item) {
            // Clear previous lines
            chartLines.forEach(line => {
                try { candleSeries.removePriceLine(line); } catch (e) { }
            });
            chartLines = [];

            // Clear previous markers
            try { candleSeries.setMarkers([]); } catch (e) { }

            if (!item || !item.t) return;
            const t = item.t;

            // Entry line
            if (t.entry_price) {
                // Calcular nivel de Fibonacci del entry
                let entryFibLevel = '';
                if (t.fib_high && t.fib_low && t.fib_high > t.fib_low) {
                    const fibLevel = ((t.entry_price - t.fib_low) / (t.fib_high - t.fib_low) * 100).toFixed(1);
                    entryFibLevel = ` (${fibLevel}%)`;
                }

                chartLines.push(candleSeries.createPriceLine({
                    price: t.entry_price,
                    color: '#ff9800',
                    lineWidth: 2,
                    lineStyle: 0,
                    axisLabelVisible: true,
                    title: 'ENTRY' + entryFibLevel
                }));
            }

            // TP line
            if (item.tpPrice) {
                chartLines.push(candleSeries.createPriceLine({
                    price: item.tpPrice,
                    color: '#22c55e',
                    lineWidth: 2,
                    lineStyle: 2,
                    axisLabelVisible: true,
                    title: 'TP'
                }));
            }

            // SL line
            if (item.slPrice && item.slPrice !== Infinity) {
                chartLines.push(candleSeries.createPriceLine({
                    price: item.slPrice,
                    color: '#ef4444',
                    lineWidth: 2,
                    lineStyle: 2,
                    axisLabelVisible: true,
                    title: 'SL'
                }));
            }

            // Fibonacci levels
            if (t.fib_high && t.fib_low) {
                // 0% (Low)
                chartLines.push(candleSeries.createPriceLine({
                    price: t.fib_low,
                    color: 'rgba(76, 175, 80, 0.8)',
                    lineWidth: 1,
                    lineStyle: 0,
                    axisLabelVisible: true,
                    title: '0%'
                }));

                // 100% (High)
                chartLines.push(candleSeries.createPriceLine({
                    price: t.fib_high,
                    color: 'rgba(244, 67, 54, 0.8)',
                    lineWidth: 1,
                    lineStyle: 0,
                    axisLabelVisible: true,
                    title: '100%'
                }));

                // Key Fibonacci levels
                const fibLevels = [
                    { level: 0.236, color: '#4caf50', label: '23.6%' },
                    { level: 0.382, color: '#8bc34a', label: '38.2%' },
                    { level: 0.5, color: '#ffeb3b', label: '50%' },
                    { level: 0.618, color: '#ff9800', label: '61.8%' },
                    { level: 0.786, color: '#ff5722', label: '78.6%' }
                ];

                const range = t.fib_high - t.fib_low;
                fibLevels.forEach(fib => {
                    const price = t.fib_low + (range * fib.level);
                    chartLines.push(candleSeries.createPriceLine({
                        price: price,
                        color: fib.color,
                        lineWidth: 1,
                        lineStyle: 2,
                        axisLabelVisible: true,
                        title: fib.label
                    }));
                });
            }

        }

        function changeTimeframe(tf) {
            currentTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tf === tf);
            });

            if (selectedTradeIndex >= 0 && processedTradesGlobal[selectedTradeIndex]) {
                const item = processedTradesGlobal[selectedTradeIndex];
                loadCandleData(item.t.symbol).then(() => drawTradeLines(item));
            }
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async function () {
            document.querySelectorAll('input[type="range"]').forEach(s => updateSliderValue(s));
            await loadSharedConfig();  // Cargar configuraci√≥n compartida primero
            autoLoadTradesJson();
        });
    </script>
</body>

</html>