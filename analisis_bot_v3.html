<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Pro V2 - Trading Bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Lightweight Charts para el gr√°fico -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="analisis_bot_v3.css">
</head>

<body class="p-4">
    <div class="w-full max-w-[98%] mx-auto space-y-4">

        <!-- Header -->
        <div class="main-header flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="main-title">üöÄ Simulador Trading Bot <span>V3</span></h1>
                <p class="text-sm text-slate-400 mt-1">An√°lisis profesional con gr√°fico integrado</p>
            </div>

            <!-- Notas de An√°lisis + Stats -->
            <div class="flex-grow mx-4 w-full md:w-1/3 flex gap-4">
                <textarea id="botNotes"
                    class="w-1/2 h-32 bg-transparent text-[#00ff00] font-bold border border-slate-700/50 rounded-xl p-4 text-2xl md:text-3xl focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none resize-none shadow-inner transition-all placeholder-slate-600 font-mono leading-relaxed"
                    style="background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); text-shadow: 0 0 5px rgba(0, 255, 0, 0.3);"
                    placeholder="üìù NOTAS..." spellcheck="false"></textarea>

                <!-- Stats in Header -->
                <div class="w-1/2 grid grid-cols-2 gap-2">
                    <div class="kpi-card kpi-blue p-2 flex flex-col justify-center h-full">
                        <div class="text-[9px] text-slate-400 font-bold uppercase">Max Posiciones</div>
                        <div class="kpi-value text-xl mt-1" id="kpi_max_sim_pos">-</div>
                    </div>
                    <div class="kpi-card kpi-purple p-2 flex flex-col justify-center h-full">
                        <div class="text-[9px] text-slate-400 font-bold uppercase">Max √ìrdenes</div>
                        <div class="kpi-value text-xl mt-1" id="kpi_max_sim_ord">-</div>
                    </div>
                    <div class="kpi-card kpi-green p-2 col-span-2 flex flex-col justify-center h-full">
                        <div class="text-[9px] text-slate-400 font-bold uppercase">Max Total Simult√°neo</div>
                        <div class="kpi-value text-xl mt-1" id="kpi_max_sim_tot">-</div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Mode Switch -->
                <div class="mode-switch-container">
                    <span class="mode-label active" id="modeLabelAnalyzer">üìä Analizador</span>
                    <label class="mode-switch">
                        <input type="checkbox" id="modeSwitch" onchange="switchMode()">
                        <span class="slider"></span>
                    </label>
                    <span class="mode-label" id="modeLabelVisor">üëÅÔ∏è Visor</span>
                </div>
                <!-- File input -->
                <div class="file-input-wrapper">
                    <button class="file-input-btn">üìÇ Cargar JSON</button>
                    <input type="file" id="fileInput" accept=".json" />
                </div>
                <button id="refreshBtn" class="hidden px-4 py-2 text-sm font-semibold rounded-lg transition-all"
                    style="background: rgba(0, 212, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue);"
                    onclick="manualRefresh()">üîÑ Actualizar</button>
            </div>
        </div>

        <div id="dashboard" class="hidden animate-in">
            <!-- Layout principal: arriba config + KPIs, abajo tabla + gr√°fico -->

            <!-- FILA SUPERIOR: Config + KPIs -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-4 mb-4">
                <!-- CONFIG EN MATRIZ 2x3 (6 columnas) -->
                <div class="xl:col-span-7">
                    <div class="card card-glow-blue p-3">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="section-header mb-0 text-xs">Config. por Caso</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="resetDefaults()"
                                    class="text-xs text-cyan-400 hover:text-cyan-300 transition-colors font-medium">‚ü≤
                                    Reiniciar</button>
                            </div>
                        </div>

                        <!-- Matriz 2x3 de casos -->
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                            <!-- C1 -->
                            <div class="case-panel case-1 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-blue)">‚ö° C1</div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="optimizeCase(1, 'total', this)"
                                            class="text-[10px] bg-blue-900/50 hover:bg-blue-800 text-blue-200 px-1.5 py-0.5 rounded border border-blue-700/50 transition-colors"
                                            title="Optimizar Total (Real + Flot)">
                                            ü™Ñ Tot
                                        </button>
                                        <button onclick="optimizeCase(1, 'realized', this)"
                                            class="text-[10px] bg-green-900/50 hover:bg-green-800 text-green-200 px-1.5 py-0.5 rounded border border-green-700/50 transition-colors"
                                            title="Optimizar Solo Realizado">
                                            üí∞ Real
                                        </button>
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c1"
                                                onchange="toggleSL(1); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">max
                                                    <span id="txt_max_tp_c1">--</span></span></label>
                                            <div class="flex gap-1">
                                                <button onclick="optimizeTP(1, 'total', this)"
                                                    class="text-[8px] bg-blue-900/30 hover:bg-blue-800 text-blue-200 px-1 rounded border border-blue-700/30 transition-colors"
                                                    title="Optimizar TP (Total)">ü™Ñ T</button>
                                                <button onclick="optimizeTP(1, 'realized', this)"
                                                    class="text-[8px] bg-green-900/30 hover:bg-green-800 text-green-200 px-1 rounded border border-green-700/30 transition-colors"
                                                    title="Optimizar TP (Realized)">üí∞ R</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c1', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c1" value="51" min="0" max="61" step="0.5"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c1', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c1', 51)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c1_val">51</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c1">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">min
                                                    <span id="txt_min_sl_c1">--</span></span></label>
                                            <div class="flex gap-1">
                                                <button onclick="optimizeSL(1, 'total', this)"
                                                    class="text-[8px] bg-red-900/30 hover:bg-red-800 text-red-200 px-1 rounded border border-red-700/30 transition-colors"
                                                    title="Optimizar SL (Total)">ü™Ñ T</button>
                                                <button onclick="optimizeSL(1, 'realized', this)"
                                                    class="text-[8px] bg-green-900/30 hover:bg-green-800 text-green-200 px-1 rounded border border-green-700/30 transition-colors"
                                                    title="Optimizar SL (Realized)">üí∞ R</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c1', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c1" value="67" min="62" max="120" step="0.5"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c1', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c1', 67)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c1_val">67</span>
                                    </div>
                                </div>
                            </div>

                            <!-- C2 eliminado -->
                            <!-- C3 -->
                            <div class="case-panel case-3 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-orange)">üî• C3</div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="optimizeCase(3, 'total', this)"
                                            class="text-[10px] bg-orange-900/50 hover:bg-orange-800 text-orange-200 px-1.5 py-0.5 rounded border border-orange-700/50 transition-colors"
                                            title="Optimizar Total (Real + Flot)">
                                            ü™Ñ Tot
                                        </button>
                                        <button onclick="optimizeCase(3, 'realized', this)"
                                            class="text-[10px] bg-green-900/50 hover:bg-green-800 text-green-200 px-1.5 py-0.5 rounded border border-green-700/50 transition-colors"
                                            title="Optimizar Solo Realizado">
                                            üí∞ Real
                                        </button>
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c3"
                                                onchange="toggleSL(3); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">max
                                                    <span id="txt_max_tp_c3">--</span></span></label>
                                            <div class="flex gap-1">
                                                <button onclick="optimizeTP(3, 'total', this)"
                                                    class="text-[8px] bg-orange-900/30 hover:bg-orange-800 text-orange-200 px-1 rounded border border-orange-700/30 transition-colors"
                                                    title="Optimizar TP (Total)">ü™Ñ T</button>
                                                <button onclick="optimizeTP(3, 'realized', this)"
                                                    class="text-[8px] bg-green-900/30 hover:bg-green-800 text-green-200 px-1 rounded border border-green-700/30 transition-colors"
                                                    title="Optimizar TP (Realized)">üí∞ R</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c3', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c3" value="61" min="0" max="78" step="0.5"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c3', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c3', 61)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c3_val">61</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c3">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">min
                                                    <span id="txt_min_sl_c3">--</span></span></label>
                                            <div class="flex gap-1">
                                                <button onclick="optimizeSL(3, 'total', this)"
                                                    class="text-[8px] bg-orange-900/30 hover:bg-orange-800 text-orange-200 px-1 rounded border border-orange-700/30 transition-colors"
                                                    title="Optimizar SL (Total)">ü™Ñ T</button>
                                                <button onclick="optimizeSL(3, 'realized', this)"
                                                    class="text-[8px] bg-green-900/30 hover:bg-green-800 text-green-200 px-1 rounded border border-green-700/30 transition-colors"
                                                    title="Optimizar SL (Realized)">üí∞ R</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c3', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c3" value="92" min="79" max="120" step="0.5"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c3', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c3', 92)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c3_val">92</span>
                                    </div>
                                </div>
                            </div>
                            <!-- C4 -->
                            <div class="case-panel case-4 p-2">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="font-bold text-xs" style="color: var(--accent-red)">üíé C4</div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="optimizeCase(4, 'total', this)"
                                            class="text-[10px] bg-red-900/50 hover:bg-red-800 text-red-200 px-1.5 py-0.5 rounded border border-red-700/50 transition-colors"
                                            title="Optimizar Total (Real + Flot)">
                                            ü™Ñ Tot
                                        </button>
                                        <button onclick="optimizeCase(4, 'realized', this)"
                                            class="text-[10px] bg-green-900/50 hover:bg-green-800 text-green-200 px-1.5 py-0.5 rounded border border-green-700/50 transition-colors"
                                            title="Optimizar Solo Realizado">
                                            üí∞ Real
                                        </button>
                                        <label class="toggle-switch" style="width: 32px; height: 16px;">
                                            <input type="checkbox" id="sl_enabled_c4"
                                                onchange="toggleSL(4); runSimulation();" checked>
                                            <span class="toggle-slider" style="border-radius: 16px;"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="slider-container">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[9px] text-slate-400">TP% <span class="text-red-400">max
                                                    <span id="txt_max_tp_c4">--</span></span></label>
                                            <div class="flex gap-1">
                                                <button onclick="optimizeTP(4, 'total', this)"
                                                    class="text-[8px] bg-red-900/30 hover:bg-red-800 text-red-200 px-1 rounded border border-red-700/30 transition-colors"
                                                    title="Optimizar TP (Total)">ü™Ñ T</button>
                                                <button onclick="optimizeTP(4, 'realized', this)"
                                                    class="text-[8px] bg-green-900/30 hover:bg-green-800 text-green-200 px-1 rounded border border-green-700/30 transition-colors"
                                                    title="Optimizar TP (Realized)">üí∞ R</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('tp_c4', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="tp_c4" value="50" min="0" max="78" step="0.5"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('tp_c4', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('tp_c4', 50)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="tp_c4_val">50</span>
                                    </div>
                                    <div class="slider-container" id="sl_container_c4">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[9px] text-slate-400">SL% <span class="text-red-400">min
                                                    <span id="txt_min_sl_c4">--</span></span></label>
                                            <div class="flex gap-1">
                                                <button onclick="optimizeSL(4, 'total', this)"
                                                    class="text-[8px] bg-red-900/30 hover:bg-red-800 text-red-200 px-1 rounded border border-red-700/30 transition-colors"
                                                    title="Optimizar SL (Total)">ü™Ñ T</button>
                                                <button onclick="optimizeSL(4, 'realized', this)"
                                                    class="text-[8px] bg-green-900/30 hover:bg-green-800 text-green-200 px-1 rounded border border-green-700/30 transition-colors"
                                                    title="Optimizar SL (Realized)">üí∞ R</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="adjustSlider('sl_c4', -1)"
                                                class="precision-btn">&lt;</button>
                                            <input type="range" id="sl_c4" value="95" min="90" max="120" step="0.5"
                                                oninput="updateSliderValue(this); runSimulation();" class="flex-1">
                                            <button type="button" onclick="adjustSlider('sl_c4', 1)"
                                                class="precision-btn">&gt;</button>
                                            <button type="button" onclick="resetSlider('sl_c4', 95)" class="reset-btn"
                                                title="Reset">‚Ü∫</button>
                                        </div>
                                        <span class="slider-value text-xs" id="sl_c4_val">95</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filtros de Ganancia (dentro del mismo card) -->

                        <!-- Ayudas Visuales -->
                        <div class="mt-3 pt-3 border-t border-slate-700/30">
                            <h4 class="text-[10px] text-slate-400 font-semibold uppercase mb-2">Ayudas Visuales</h4>
                            <div class="slider-container">
                                <label class="text-[9px] text-slate-400">L√≠nea Gu√≠a (Fib %)</label>
                                <div class="flex items-center gap-1">
                                    <button type="button" onclick="adjustSlider('guide_line', -1)"
                                        class="precision-btn">&lt;</button>
                                    <input type="range" id="guide_line" value="65" min="0" max="150" step="0.5"
                                        oninput="updateSliderValue(this); updateChartLinesFromSlider();" class="flex-1">
                                    <button type="button" onclick="adjustSlider('guide_line', 1)"
                                        class="precision-btn">&gt;</button>
                                    <button type="button" onclick="resetSlider('guide_line', 65)" class="reset-btn"
                                        title="Reset">‚Ü∫</button>
                                </div>
                                <span class="slider-value text-xs" id="guide_line_val" style="color: #3b82f6;">65</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- KPIs + Rendimiento por Caso (5 columnas a la derecha) -->
                <div class="xl:col-span-5 space-y-3">
                    <!-- KPIs -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-1">
                        <div class="kpi-card kpi-blue p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">PnL Realizado</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_realized_pnl">$0.00</div>
                        </div>
                        <div class="kpi-card kpi-gray p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">PnL Flotante</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_floating_pnl">$0.00</div>
                        </div>
                        <div class="kpi-card kpi-purple p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">Total</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_total_pnl">$0.00</div>
                        </div>
                        <div class="kpi-card p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">Win Rate</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_winrate" style="color: var(--accent-blue);">
                                0%</div>
                            <div class="text-[7px] text-slate-500" id="kpi_trades_info">0/0</div>
                        </div>
                        <div class="kpi-card kpi-green p-2">
                            <div class="text-[8px] text-slate-400 font-bold uppercase">Profit Factor</div>
                            <div class="kpi-value text-base mt-0.5" id="kpi_pf" style="color: var(--accent-green);">0.00
                            </div>
                        </div>
                    </div>



                    <!-- Tabla Rendimiento por Caso (Elegante) -->
                    <div class="card p-3"
                        style="background: linear-gradient(145deg, rgba(22, 33, 62, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%); border: 1px solid rgba(168, 85, 247, 0.2);">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm">üìä</span>
                                <h3 class="font-bold text-xs" style="color: var(--accent-purple);">Rendimiento por Caso
                                </h3>
                            </div>
                            <button onclick="toggleCaseTable()" id="btnToggleCaseTable"
                                class="text-[10px] text-slate-400 hover:text-white px-2 py-1 rounded transition-all"
                                style="background: rgba(0,0,0,0.3);">Ocultar</button>
                        </div>
                        <div id="caseTableContainer" class="overflow-x-auto">
                            <table class="w-full" style="border-collapse: separate; border-spacing: 0 2px;">
                                <thead>
                                    <tr style="background: rgba(0, 0, 0, 0.3);">
                                        <th
                                            class="text-left py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Caso</th>
                                        <th
                                            class="text-center py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Cerr/Tot</th>
                                        <th
                                            class="text-center py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            WR</th>
                                        <th
                                            class="text-center py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            PF</th>
                                        <th
                                            class="text-right py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Real</th>
                                        <th
                                            class="text-right py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Flot</th>
                                        <th
                                            class="text-right py-1 px-2 text-[10px] text-slate-400 font-semibold uppercase">
                                            Total</th>
                                    </tr>
                                </thead>
                                <tbody id="casePerformanceTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILA INFERIOR: Lista de Operaciones + Gr√°fico -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-4 mt-4">

                <!-- IZQUIERDA: Lista de Operaciones (5 columnas) -->
                <div class="xl:col-span-5 space-y-3">

                    <!-- Lista de Operaciones (NO ignorados) -->
                    <div class="card overflow-hidden p-0">
                        <!-- Header con t√≠tulo y FILTRAR (selecci√≥n m√∫ltiple + texto) -->
                        <div class="px-3 py-2 border-b border-slate-700/30 flex items-center justify-between gap-2"
                            style="background: linear-gradient(90deg, rgba(168, 85, 247, 0.1) 0%, transparent 100%);">

                            <div class="flex items-center gap-2">
                                <span class="text-sm">üìú</span>
                                <h3 class="font-bold text-slate-200 text-xs">Operaciones</h3>
                                <button onclick="exportTableToCSV()"
                                    class="text-[9px] text-teal-400 hover:text-teal-200 ml-2" title="Exportar a CSV">üíæ
                                    CSV</button>
                                <button onclick="toggleMainList()" id="btnToggleMain"
                                    class="text-[9px] text-slate-400 hover:text-white ml-2">(Ocultar)</button>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-[9px] text-slate-400 font-semibold uppercase">Filtrar:</span>
                                <button onclick="toggleCaseFilter(0)" id="btnCaseAll"
                                    class="filter-btn active text-[9px] px-1.5 py-0.5">Todos</button>
                                <button onclick="toggleCaseFilter(1)" id="btnCase1"
                                    class="filter-btn btn-c1 text-[9px] px-1.5 py-0.5">C1</button>
                                <!-- C2 eliminado -->
                                <button onclick="toggleCaseFilter(3)" id="btnCase3"
                                    class="filter-btn btn-c3 text-[9px] px-1.5 py-0.5">C3</button>
                                <button onclick="toggleCaseFilter(4)" id="btnCase4"
                                    class="filter-btn btn-c4 text-[9px] px-1.5 py-0.5">C4</button>
                                <input type="text" id="filterText" placeholder="Buscar par..." oninput="runSimulation()"
                                    class="text-[9px] px-2 py-0.5 rounded border border-slate-600 bg-transparent text-slate-200 w-20 focus:outline-none focus:border-cyan-400 placeholder-slate-500">
                            </div>
                        </div>

                        <!-- ORDENAR -->
                        <div class="px-3 py-1 border-b border-slate-700/20 flex items-center gap-2"
                            style="background: rgba(0, 0, 0, 0.2);">
                            <span class="text-[9px] text-slate-400 font-semibold uppercase">Ordenar:</span>
                            <button onclick="setSortMode('none')" id="btnSortNone"
                                class="filter-btn active text-[9px] px-1.5 py-0.5">Defecto</button>
                            <button onclick="setSortMode('pnl_real_desc')" id="btnSortPnlRealDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">PnL ‚Üì</button>
                            <button onclick="setSortMode('pnl_real_asc')" id="btnSortPnlRealAsc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">PnL ‚Üë</button>
                            <button onclick="setSortMode('pnl_flot_desc')" id="btnSortPnlFlotDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">Flot ‚Üì</button>
                            <button onclick="setSortMode('pnl_flot_asc')" id="btnSortPnlFlotAsc"
                                class="filter-btn text-[9px] px-1.5 py-0.5">Flot ‚Üë</button>
                            <button onclick="setSortMode('fib_desc')" id="btnSortFibDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5"
                                style="color: var(--accent-purple); border-color: rgba(168, 85, 247, 0.3);">Fib
                                ‚Üì</button>
                            <button onclick="setSortMode('fib_creation_desc')" id="btnSortMarginDesc"
                                class="filter-btn text-[9px] px-1.5 py-0.5"
                                style="color: var(--accent-orange); border-color: rgba(255, 152, 0, 0.3);">Margen
                                ‚Üì</button>
                        </div>

                        <!-- AISLAR (Antes Ignorar) -->
                        <div class="px-3 py-1 border-b border-slate-700/20 flex items-center gap-2"
                            style="background: rgba(0, 0, 0, 0.15);">
                            <span class="text-[9px] text-slate-400 font-semibold uppercase">Aislar:</span>
                            <div class="flex items-center gap-1">
                                <button onclick="setIsolation('none')" id="btnIsoNone"
                                    class="filter-btn active text-[9px] px-2 py-0.5 rounded border border-slate-600/50 text-slate-400 hover:text-white transition-colors">Ninguno</button>

                                <button onclick="setIsolation(1)" id="btnIso1"
                                    class="filter-btn text-[9px] px-2 py-0.5 rounded border border-slate-600/50 text-slate-400 hover:text-blue-300 hover:border-blue-500/50 transition-colors">C1</button>

                                <button onclick="setIsolation(3)" id="btnIso3"
                                    class="filter-btn text-[9px] px-2 py-0.5 rounded border border-slate-600/50 text-slate-400 hover:text-orange-300 hover:border-orange-500/50 transition-colors">C3</button>

                                <button onclick="setIsolation(4)" id="btnIso4"
                                    class="filter-btn text-[9px] px-2 py-0.5 rounded border border-slate-600/50 text-slate-400 hover:text-red-300 hover:border-red-500/50 transition-colors">C4</button>

                                <button onclick="setIsolation('all')" id="btnIsoAll"
                                    class="filter-btn text-[9px] px-2 py-0.5 rounded border border-slate-600/50 text-slate-400 hover:text-white transition-colors">Todos</button>
                            </div>
                        </div>

                        <!-- Tabla de operaciones -->
                        <div id="mainTradesContainer" class="overflow-y-auto" style="max-height: 600px;">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th class="text-left text-[10px] py-1 px-2">Par</th>
                                        <th class="text-center text-[10px] py-1">Caso</th>
                                        <th class="text-center text-[10px] py-1" title="Origen: SIM=Simulado">Src</th>
                                        <th class="text-center text-[10px] py-1"
                                            title="Margen requerido para 1 USD Profit">Margin</th>
                                        <th class="text-center text-[10px] py-1">Estado</th>
                                        <th class="text-right text-[10px] py-1">Real</th>
                                        <th class="text-right text-[10px] py-1">Flot</th>
                                        <th class="text-center text-[10px] py-1">R:R</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="px-2 py-1 border-t border-slate-700/20" style="background: rgba(0, 0, 0, 0.2);">
                            <span class="text-[10px] text-slate-400" id="filter_stats_text">Total: 0 trades</span>
                        </div>
                    </div>



                    <!-- Lista de √ìrdenes L√≠mite (Pendientes) -->
                    <div id="limitOrdersSection" class="card overflow-hidden p-0 hidden"
                        style="border: 1px solid rgba(255, 152, 0, 0.3);">
                        <div class="px-3 py-2 border-b border-slate-700/30 flex items-center justify-between"
                            style="background: rgba(255, 152, 0, 0.05);">
                            <div class="flex items-center gap-2">
                                <span class="text-[12px]">‚è≥</span>
                                <h3 class="font-bold text-slate-200 text-xs">√ìrdenes Limit (Pendientes)</h3>
                                <span id="limitCount" class="text-[9px] text-slate-500">(0)</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- Toggle Simular Pending -->
                                <div class="flex items-center gap-1" title="Simular √≥rdenes pendientes">
                                    <span class="text-[9px] text-slate-400">Simular</span>
                                    <label class="toggle-switch" style="width: 32px; height: 16px;">
                                        <input type="checkbox" id="simulatePendingToggle"
                                            onchange="toggleSimulatePending()">
                                        <span class="toggle-slider" style="border-radius: 16px;"></span>
                                    </label>
                                </div>
                                <button onclick="toggleLimitList()" id="btnToggleLimit"
                                    class="text-[9px] text-slate-400 hover:text-white">Ocultar</button>
                            </div>
                        </div>
                        <div id="limitOrdersContainer" class="overflow-y-auto" style="max-height: 200px;">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th class="text-left text-[10px] py-1 px-2">Par</th>
                                        <th class="text-center text-[10px] py-1">Caso</th>
                                        <th class="text-center text-[10px] py-1">Creado</th>
                                        <th class="text-center text-[10px] py-1">Margin</th>
                                        <th class="text-right text-[10px] py-1">Precio Entry</th>
                                        <th class="text-right text-[10px] py-1">Distancia</th>
                                    </tr>
                                </thead>
                                <tbody id="limitOrdersBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Lista de √ìrdenes Canceladas -->
                    <div id="cancelledOrdersSection" class="card overflow-hidden p-0 hidden"
                        style="border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div class="px-3 py-2 border-b border-slate-700/30 flex items-center justify-between"
                            style="background: rgba(239, 68, 68, 0.05);">
                            <div class="flex items-center gap-2">
                                <span class="text-[12px]">üö´</span>
                                <h3 class="font-bold text-slate-200 text-xs">√ìrdenes Canceladas</h3>
                                <span id="cancelledCount" class="text-[9px] text-slate-500">(0)</span>
                            </div>
                            <button onclick="toggleCancelledList()" id="btnToggleCancelled"
                                class="text-[9px] text-slate-400 hover:text-white">Ocultar</button>
                        </div>
                        <div id="cancelledOrdersContainer" class="overflow-y-auto" style="max-height: 200px;">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th class="text-left text-[10px] py-1 px-2">Par</th>
                                        <th class="text-center text-[10px] py-1">Caso</th>
                                        <th class="text-center text-[10px] py-1">Creado</th>
                                        <th class="text-center text-[10px] py-1">Cancelado</th>
                                        <th class="text-left text-[10px] py-1">Raz√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="cancelledOrdersBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Lista de Ignorados (aparece solo si hay ignorados) -->
                    <div id="ignoredTradesSection" class="card overflow-hidden p-0 hidden" style="opacity: 0.7;">
                        <div class="px-3 py-2 border-b border-slate-700/30 flex items-center justify-between"
                            style="background: rgba(100, 100, 100, 0.2);">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px]">üö´</span>
                                <span class="text-[10px] text-slate-400 font-semibold">Ignorados</span>
                                <span id="ignoredCount" class="text-[9px] text-slate-500">(0)</span>
                            </div>
                            <button onclick="toggleIgnoredList()" id="btnToggleIgnored"
                                class="text-[9px] text-slate-400 hover:text-white">Mostrar</button>
                        </div>
                        <div id="ignoredTradesContainer" class="overflow-y-auto hidden" style="max-height: 150px;">
                            <table class="modern-table">
                                <tbody id="ignoredTradesBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- DERECHA: Panel del Gr√°fico (7 columnas) -->
                <div class="xl:col-span-7">
                    <!-- Panel del Gr√°fico -->
                    <div class="chart-panel" style="height: 100%;">
                        <div class="chart-header">
                            <div class="flex items-center gap-3">
                                <span class="chart-symbol" id="chartSymbol">Selecciona un trade</span>
                                <span id="chartCaseBadge" class="badge bg-neutral hidden">-</span>
                            </div>
                            <div class="chart-timeframe-btns">
                                <button class="tf-btn" data-tf="1" onclick="changeTimeframe('1')">1m</button>
                                <button class="tf-btn" data-tf="5" onclick="changeTimeframe('5')">5m</button>
                                <button class="tf-btn active" data-tf="15" onclick="changeTimeframe('15')">15m</button>
                                <button class="tf-btn" data-tf="60" onclick="changeTimeframe('60')">1H</button>
                                <button class="tf-btn" data-tf="240" onclick="changeTimeframe('240')">4H</button>
                            </div>
                        </div>
                        <div id="chartContainer" style="min-height: 550px;">
                            <div class="chart-placeholder">
                                <div class="chart-placeholder-icon">üìà</div>
                                <div>Haz clic en una operaci√≥n para ver el gr√°fico</div>
                            </div>
                        </div>
                        <div class="chart-info" id="chartInfo" style="display: none;">
                            <div class="chart-info-item">
                                <span class="chart-info-label">Entry:</span>
                                <span class="chart-info-value" id="infoEntry" style="color: #ff9800;">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">TP:</span>
                                <span class="chart-info-value" id="infoTP" style="color: var(--accent-green);">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">SL:</span>
                                <span class="chart-info-value" id="infoSL" style="color: var(--accent-red);">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">Fib 0%:</span>
                                <span class="chart-info-value" id="infoFibLow" style="color: #4caf50;">-</span>
                            </div>
                            <div class="chart-info-item">
                                <span class="chart-info-label">Fib 100%:</span>
                                <span class="chart-info-value" id="infoFibHigh" style="color: #f44336;">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-save notes logic
        document.addEventListener('DOMContentLoaded', () => {
            const noteArea = document.getElementById('botNotes');
            if (noteArea) {
                // Load saved notes
                const savedNotes = localStorage.getItem('botNotes_v3');
                if (savedNotes) noteArea.value = savedNotes;

                // Save on input
                noteArea.addEventListener('input', () => {
                    localStorage.setItem('botNotes_v3', noteArea.value);
                });
            }
        });
    </script>
    <script src="analisis_bot_v3.js?v=3.1"></script>
</body>

</html>